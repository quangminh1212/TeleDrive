{% extends "base.html" %}

{% block title %}Advanced Search - TeleDrive{% endblock %}

{% block content %}
<div class="main-content">
    <div class="content-header">
        <h1 class="page-title">
            <span class="material-icons">search</span>
            Advanced Search
        </h1>
    </div>
    
    <div class="search-container-advanced">
        <!-- Search Input -->
        <div class="search-input-section">
            <div class="search-input-wrapper">
                <span class="material-icons search-icon">search</span>
                <input type="text" id="advanced-search-input" class="search-input-advanced" 
                       placeholder="Search files, folders, and content..." autocomplete="off">
                <button class="btn btn-primary" onclick="performAdvancedSearch()">
                    <span class="material-icons">search</span>
                    Search
                </button>
            </div>
            <div class="search-suggestions-advanced" id="search-suggestions-advanced"></div>
        </div>
        
        <!-- Advanced Filters -->
        <div class="filters-section">
            <div class="filters-header">
                <h3>Filters</h3>
                <button class="btn btn-small" onclick="clearAllFilters()">
                    <span class="material-icons">clear</span>
                    Clear All
                </button>
            </div>
            
            <div class="filters-grid">
                <!-- File Type Filter -->
                <div class="filter-group">
                    <label class="filter-label">File Type</label>
                    <select id="file-type-filter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="image">Images</option>
                        <option value="video">Videos</option>
                        <option value="audio">Audio</option>
                        <option value="document">Documents</option>
                        <option value="archive">Archives</option>
                    </select>
                </div>
                
                <!-- Folder Filter -->
                <div class="filter-group">
                    <label class="filter-label">Folder</label>
                    <select id="folder-filter" class="filter-select">
                        <option value="">All Folders</option>
                        <option value="root">Root Folder</option>
                    </select>
                </div>
                
                <!-- Date Range Filter -->
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="date-range">
                        <input type="date" id="date-from" class="filter-input">
                        <span>to</span>
                        <input type="date" id="date-to" class="filter-input">
                    </div>
                </div>
                
                <!-- File Size Filter -->
                <div class="filter-group">
                    <label class="filter-label">File Size (MB)</label>
                    <div class="size-range">
                        <input type="number" id="size-min" class="filter-input" placeholder="Min" min="0">
                        <span>to</span>
                        <input type="number" id="size-max" class="filter-input" placeholder="Max" min="0">
                    </div>
                </div>
                
                <!-- Channel Filter -->
                <div class="filter-group">
                    <label class="filter-label">Telegram Channel</label>
                    <input type="text" id="channel-filter" class="filter-input" placeholder="Channel name">
                </div>
                
                <!-- Tags Filter -->
                <div class="filter-group">
                    <label class="filter-label">Tags</label>
                    <input type="text" id="tags-filter" class="filter-input" placeholder="tag1, tag2, tag3">
                </div>
            </div>
        </div>
        
        <!-- Sort Options -->
        <div class="sort-section">
            <div class="sort-group">
                <label class="filter-label">Sort by</label>
                <select id="sort-by" class="filter-select">
                    <option value="relevance">Relevance</option>
                    <option value="date">Date</option>
                    <option value="name">Name</option>
                    <option value="size">Size</option>
                    <option value="type">Type</option>
                </select>
            </div>
            <div class="sort-group">
                <label class="filter-label">Order</label>
                <select id="sort-order" class="filter-select">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Search Results -->
    <div class="search-results-section">
        <div class="results-header" id="results-header" style="display: none;">
            <div class="results-info">
                <span id="results-count">0</span> results found
                <span id="search-query-display"></span>
            </div>
            <div class="results-actions">
                <button class="btn btn-small" onclick="exportSearchResults()">
                    <span class="material-icons">download</span>
                    Export Results
                </button>
            </div>
        </div>
        
        <div class="search-results" id="search-results">
            <div class="search-placeholder">
                <span class="material-icons">search</span>
                <h3>Start searching to see results</h3>
                <p>Use the search box above or apply filters to find your files</p>
            </div>
        </div>
        
        <!-- Loading State -->
        <div class="search-loading" id="search-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Searching...</p>
        </div>
    </div>
</div>

<!-- Search Help Modal -->
<div class="modal" id="search-help-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Search Help</h3>
            <button class="modal-close" onclick="hideSearchHelp()">&times;</button>
        </div>
        <div class="modal-body">
            <h4>Search Operators</h4>
            <ul class="help-list">
                <li><code>type:image</code> - Find only image files</li>
                <li><code>size:>10mb</code> - Files larger than 10MB</li>
                <li><code>date:2024-01-01</code> - Files from specific date</li>
                <li><code>tag:important</code> - Files with specific tag</li>
                <li><code>channel:mychannel</code> - Files from specific channel</li>
            </ul>
            
            <h4>Search Tips</h4>
            <ul class="help-list">
                <li>Use quotes for exact phrases: <code>"exact phrase"</code></li>
                <li>Use wildcards: <code>file*.txt</code></li>
                <li>Combine multiple terms: <code>document important</code></li>
                <li>Use filters for precise results</li>
            </ul>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="hideSearchHelp()">Got it</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let searchTimeout;
let currentSearchQuery = '';

// Initialize search page
document.addEventListener('DOMContentLoaded', function() {
    loadFoldersForFilter();
    setupSearchEventListeners();
    
    // Check if there's a search query in URL
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
        document.getElementById('advanced-search-input').value = query;
        performAdvancedSearch();
    }
});

function setupSearchEventListeners() {
    const searchInput = document.getElementById('advanced-search-input');
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                loadAdvancedSearchSuggestions(query);
            }, 300);
        } else {
            hideAdvancedSearchSuggestions();
        }
    });
    
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performAdvancedSearch();
        }
    });
    
    // Auto-search when filters change
    const filterElements = [
        'file-type-filter', 'folder-filter', 'date-from', 'date-to',
        'size-min', 'size-max', 'channel-filter', 'tags-filter',
        'sort-by', 'sort-order'
    ];
    
    filterElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                if (currentSearchQuery) {
                    performAdvancedSearch();
                }
            });
        }
    });
}

function loadAdvancedSearchSuggestions(query) {
    fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=8`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.suggestions.length > 0) {
                showAdvancedSearchSuggestions(data.suggestions);
            } else {
                hideAdvancedSearchSuggestions();
            }
        })
        .catch(error => {
            console.error('Error loading search suggestions:', error);
            hideAdvancedSearchSuggestions();
        });
}

function showAdvancedSearchSuggestions(suggestions) {
    const container = document.getElementById('search-suggestions-advanced');
    
    // Group suggestions by category
    const grouped = {};
    suggestions.forEach(suggestion => {
        const category = suggestion.category || 'Other';
        if (!grouped[category]) {
            grouped[category] = [];
        }
        grouped[category].push(suggestion);
    });
    
    let html = '';
    Object.keys(grouped).forEach(category => {
        html += `<div class="suggestion-category">
            <div class="suggestion-category-title">${category}</div>`;
        
        grouped[category].forEach(suggestion => {
            html += `
                <div class="search-suggestion-item" onclick="selectAdvancedSuggestion('${suggestion.text}')">
                    <span class="material-icons">${suggestion.icon}</span>
                    <div class="suggestion-content">
                        <span class="suggestion-text">${suggestion.text}</span>
                        ${suggestion.description ? `<span class="suggestion-desc">${suggestion.description}</span>` : ''}
                    </div>
                </div>`;
        });
        
        html += '</div>';
    });
    
    container.innerHTML = html;
    container.style.display = 'block';
}

function hideAdvancedSearchSuggestions() {
    document.getElementById('search-suggestions-advanced').style.display = 'none';
}

function selectAdvancedSuggestion(text) {
    document.getElementById('advanced-search-input').value = text;
    hideAdvancedSearchSuggestions();
    performAdvancedSearch();
}

function performAdvancedSearch() {
    const query = document.getElementById('advanced-search-input').value.trim();
    
    if (!query) {
        showToast('Please enter a search query', 'warning');
        return;
    }
    
    currentSearchQuery = query;
    hideAdvancedSearchSuggestions();
    showSearchLoading();
    
    // Build search parameters
    const params = new URLSearchParams({
        q: query,
        type: document.getElementById('file-type-filter').value,
        folder_id: document.getElementById('folder-filter').value,
        date_from: document.getElementById('date-from').value,
        date_to: document.getElementById('date-to').value,
        size_min: document.getElementById('size-min').value,
        size_max: document.getElementById('size-max').value,
        channel: document.getElementById('channel-filter').value,
        tags: document.getElementById('tags-filter').value,
        sort_by: document.getElementById('sort-by').value,
        sort_order: document.getElementById('sort-order').value,
        limit: 100
    });
    
    fetch(`/api/search?${params}`)
        .then(response => response.json())
        .then(data => {
            hideSearchLoading();
            if (data.success) {
                displaySearchResults(data.results, data.query, data.total);
            } else {
                showToast(data.error, 'error');
            }
        })
        .catch(error => {
            hideSearchLoading();
            showToast('Search failed: ' + error.message, 'error');
        });
}

function displaySearchResults(results, query, total) {
    const container = document.getElementById('search-results');
    const header = document.getElementById('results-header');
    const countElement = document.getElementById('results-count');
    const queryDisplay = document.getElementById('search-query-display');
    
    // Update header
    countElement.textContent = total;
    queryDisplay.textContent = query ? `for "${query}"` : '';
    header.style.display = 'flex';
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="search-placeholder">
                <span class="material-icons">search_off</span>
                <h3>No results found</h3>
                <p>Try adjusting your search terms or filters</p>
            </div>
        `;
        return;
    }
    
    // Display results
    let html = '<div class="search-results-grid">';
    
    results.forEach(file => {
        const fileIcon = getFileIcon(file.filename);
        const fileSize = formatFileSize(file.file_size || 0);
        const fileDate = new Date(file.created_at).toLocaleDateString();
        
        html += `
            <div class="search-result-card" onclick="previewFile('${file.filename}')">
                <div class="result-icon">
                    <span class="material-icons">${fileIcon}</span>
                </div>
                <div class="result-info">
                    <div class="result-name">${file.filename}</div>
                    <div class="result-details">
                        <span class="result-size">${fileSize}</span>
                        <span class="result-date">${fileDate}</span>
                        ${file.telegram_channel ? `<span class="result-channel">${file.telegram_channel}</span>` : ''}
                    </div>
                    ${file.relevance_score ? `<div class="result-relevance">Relevance: ${file.relevance_score}</div>` : ''}
                </div>
                <div class="result-actions">
                    <button class="btn btn-small" onclick="event.stopPropagation(); downloadFile('${file.filename}')">
                        <span class="material-icons">download</span>
                    </button>
                    <button class="btn btn-small" onclick="event.stopPropagation(); showFileMenu(event, '${file.filename}')">
                        <span class="material-icons">more_vert</span>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const iconMap = {
        // Images
        'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image', 'webp': 'image',
        // Videos
        'mp4': 'movie', 'avi': 'movie', 'mov': 'movie', 'webm': 'movie',
        // Audio
        'mp3': 'music_note', 'wav': 'music_note', 'flac': 'music_note', 'm4a': 'music_note',
        // Documents
        'pdf': 'picture_as_pdf', 'doc': 'description', 'docx': 'description', 'txt': 'description',
        // Archives
        'zip': 'archive', 'rar': 'archive', '7z': 'archive',
        // Code
        'json': 'code', 'csv': 'table_chart', 'xlsx': 'table_chart'
    };
    
    return iconMap[ext] || 'insert_drive_file';
}

function clearAllFilters() {
    document.getElementById('file-type-filter').value = '';
    document.getElementById('folder-filter').value = '';
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    document.getElementById('size-min').value = '';
    document.getElementById('size-max').value = '';
    document.getElementById('channel-filter').value = '';
    document.getElementById('tags-filter').value = '';
    document.getElementById('sort-by').value = 'relevance';
    document.getElementById('sort-order').value = 'desc';
    
    if (currentSearchQuery) {
        performAdvancedSearch();
    }
}

function showSearchLoading() {
    document.getElementById('search-loading').style.display = 'flex';
    document.getElementById('search-results').style.display = 'none';
}

function hideSearchLoading() {
    document.getElementById('search-loading').style.display = 'none';
    document.getElementById('search-results').style.display = 'block';
}

function loadFoldersForFilter() {
    fetch('/api/folders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('folder-filter');
                
                function addFolderOptions(folders, prefix = '') {
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = prefix + folder.name;
                        select.appendChild(option);
                        
                        if (folder.children && folder.children.length > 0) {
                            addFolderOptions(folder.children, prefix + '  ');
                        }
                    });
                }
                
                addFolderOptions(data.folders);
            }
        })
        .catch(error => {
            console.error('Error loading folders:', error);
        });
}

function exportSearchResults() {
    // Implementation for exporting search results
    showToast('Export functionality coming soon', 'info');
}

function showSearchHelp() {
    document.getElementById('search-help-modal').style.display = 'flex';
}

function hideSearchHelp() {
    document.getElementById('search-help-modal').style.display = 'none';
}
</script>
{% endblock %}
