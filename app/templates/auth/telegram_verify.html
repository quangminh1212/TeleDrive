<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Code - TeleDrive</title>

    <!-- Telegram-like styling -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
        }

        .logo .material-icons {
            font-size: 48px;
            color: #0088cc;
            margin-right: 12px;
        }

        .logo-text {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
        }

        .phone-display {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 24px;
            font-family: monospace;
            font-size: 16px;
            color: #333;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: #fff;
            text-align: center;
            font-family: monospace;
            letter-spacing: 2px;
        }

        .form-control:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }

        .form-control.password-field {
            text-align: left;
            font-family: inherit;
            letter-spacing: normal;
        }

        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover:not(:disabled) {
            background: #006699;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-loading {
            background: #006699 !important;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .btn-loading .loading-spinner {
            display: inline-block;
        }

        .btn-loading .btn-text {
            opacity: 0.8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-links {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-link {
            color: #0088cc;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .auth-link:hover {
            color: #006699;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .field-error {
            color: #c62828;
            font-size: 12px;
            margin-top: 4px;
        }

        .telegram-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .telegram-info h4 {
            color: #1565c0;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .telegram-info p {
            color: #1976d2;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .two-factor-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e1e5e9;
        }

        .two-factor-info {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #e65100;
        }

        .timing-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #1565c0;
        }

        .timing-info strong {
            color: #0d47a1;
        }

        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        .processing-info {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #e65100;
            display: none;
        }

        @media (max-width: 480px) {
            .auth-container {
                padding: 32px 24px;
                margin: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">
            <span class="material-icons">telegram</span>
            <span class="logo-text">TeleDrive</span>
        </div>

        <h1 class="auth-title">Enter Verification Code</h1>
        <p class="auth-subtitle">We sent a code to your Telegram</p>

        {% if phone_number %}
        <div class="phone-display">{{ phone_number }}</div>
        {% endif %}

        <div class="telegram-info">
            <h4>Check your Telegram app:</h4>
            <p>‚Ä¢ Open Telegram on your phone or computer</p>
            <p>‚Ä¢ Look for a message with your verification code</p>
            <p>‚Ä¢ Enter the 5-6 digit code below</p>
        </div>

        <div class="timing-info">
            <strong>‚è∞ Important:</strong> Verification codes expire after a few minutes. If you get an "expired" error even with the correct code, simply request a new code - this is normal and happens when too much time has passed.
        </div>

        <div class="processing-info" id="processingInfo">
            üîÑ Processing verification... This may take a few seconds.
        </div>

        <div class="debug-info" id="debugInfo" style="display:none;">
            Debug info will appear here during testing
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('telegram_verify') }}">
            {{ form.hidden_tag() }}

            <div class="form-group">
                <label for="verification_code">Verification Code</label>
                {{ form.verification_code(class="form-control", placeholder="12345", maxlength="6", autocomplete="off") }}
                {% if form.verification_code.errors %}
                    {% for error in form.verification_code.errors %}
                        <div class="field-error">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            {% if requires_password %}
            <div class="two-factor-section">
                <div class="two-factor-info">
                    Two-factor authentication is enabled on your account. Please enter your password.
                </div>
                <div class="form-group">
                    <label for="password">Two-Factor Password</label>
                    {{ form.password(class="form-control password-field", placeholder="Enter your 2FA password") }}
                    {% if form.password.errors %}
                        {% for error in form.password.errors %}
                            <div class="field-error">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn-primary" id="submitBtn">
                <div class="loading-spinner"></div>
                <span class="btn-text">Verify Code</span>
            </button>
        </form>

        <div class="auth-links">
            <a href="{{ url_for('telegram_login') }}" class="auth-link">‚Üê Try different number</a>
            <button id="resendBtn" type="button" class="auth-link" style="border:none;background:none;cursor:pointer;padding:0;">Request new code</button>
        </div>
    </div>

    <script>
        // Auto-refresh CSRF token every 30 minutes
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(function() {
                fetch('/api/csrf-token', { credentials: 'same-origin' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.csrf_token) {
                            const csrfInput = document.querySelector('input[name="csrf_token"]');
                            if (csrfInput) {
                                csrfInput.value = data.csrf_token;
                                console.log('CSRF token refreshed automatically');
                            }
                        }
                    })
                    .catch(error => {
                        console.warn('Failed to refresh CSRF token:', error);
                    });
            }, 30 * 60 * 1000); // 30 minutes
        });


            // Countdown for code validity and Resend handler
            (function() {
                const validitySeconds = {{ validity_seconds|default(180) }};
                const codeSentAt = {{ code_sent_at or 0 }};
                const serverTime = {{ server_time or 0 }};
                let skew = 0;
                if (serverTime > 0) {
                    // estimate clock skew
                    skew = Math.floor(Date.now()/1000) - serverTime;
                }

                // Inject a small hint under the form
                const formEl = document.querySelector('form');
                const hint = document.createElement('div');
                hint.style.cssText = 'font-size:13px;color:#666;margin-top:8px;';
                hint.id = 'codeValidityHint';
                formEl.parentNode.insertBefore(hint, formEl.nextSibling);

                function updateCountdown() {
                    if (!codeSentAt) return;
                    const now = Math.floor(Date.now()/1000) - skew;
                    const elapsed = now - codeSentAt;
                    const remaining = Math.max(validitySeconds - elapsed, 0);
                    const mm = Math.floor(remaining/60);
                    const ss = remaining % 60;
                    hint.textContent = remaining > 0
                        ? `Code is valid for about ${mm}m ${ss}s. If it fails, use Request new code.`
                        : 'The code may have expired. Please click Request new code.';
                }
                setInterval(updateCountdown, 1000);
                updateCountdown();

                const resendBtn = document.getElementById('resendBtn');
                if (resendBtn) {
                    resendBtn.addEventListener('click', function() {
                        resendBtn.disabled = true;
                        resendBtn.textContent = 'Sending...';
                        const csrf = (document.querySelector('input[name="csrf_token"]').value || '');
                        fetch('/telegram_resend', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'X-CSRFToken': csrf, 'Accept': 'application/json' }
                        })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                showErrorNotification('‚úÖ New code sent. Please check Telegram and enter the new code.');
                                // Refresh CSRF and update sent time via API
                                return fetch('/api/csrf-token', { credentials: 'same-origin' })
                                       .then(r=>r.json())
                                       .then(tok => { if (tok.success) { document.querySelector('input[name="csrf_token"]').value = tok.csrf_token; }})
                                       .finally(() => {
                                           // Reset countdown starting now (best-effort)
                                           const now = Math.floor(Date.now()/1000) - skew;
                                           window.__codeSentAt = now;
                                           // Replace codeSentAt for the countdown
                                           // Not re-rendering template, so override local variable via closure
                                           // Recompute using new baseline
                                           const newBase = now;
                                           setInterval(()=>{
                                               const cur = Math.floor(Date.now()/1000) - skew;
                                               const rem = Math.max(validitySeconds - (cur - newBase), 0);
                                               const mm = Math.floor(rem/60);
                                               const ss = rem % 60;
                                               hint.textContent = rem > 0
                                                   ? `Code is valid for about ${mm}m ${ss}s. If it fails, use Request new code.`
                                                   : 'The code may have expired. Please click Request new code.';
                                           }, 1000);
                                       });
                            } else {
                                showErrorNotification(data.message || 'Failed to resend code.');
                            }
                        })
                        .catch(err => {
                            console.error('Resend error:', err);
                            showErrorNotification('Network error while resending code.');
                        })
                        .finally(() => {
                            resendBtn.disabled = false;
                            resendBtn.textContent = 'Request new code';
                        });
                    });
                }
            })();

        // Auto-refresh CSRF token on form submission if expired
        document.querySelector('form').addEventListener('submit', function(e) {
            const form = this;
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');

            // Prevent double submission
            if (submitBtn.disabled || form.dataset.submitting === 'true') {
                console.log('[FORM] Form already being submitted, ignoring');
                e.preventDefault();
                return false;
            }

            // Mark form as submitting
            form.dataset.submitting = 'true';

            // Show loading state immediately
            showLoadingState(submitBtn, btnText);
            console.log('[FORM] Form submitted, showing loading state');

            // Check if this is a retry after CSRF error
            if (form.dataset.csrfRetry) {
                delete form.dataset.csrfRetry;
                console.log('[FORM] Retry submission, allowing normal flow');
                return; // Allow normal submission
            }

            e.preventDefault();
            console.log('[FORM] Prevented default, starting verification');

            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': formData.get('csrf_token') || (document.querySelector('input[name="csrf_token"]').value || ''),
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log('[FORM] Response received:', response.status);
                if (response.ok) {
                    // Success - show success state briefly then redirect
                    showSuccessState(submitBtn, btnText);
                    setTimeout(() => {
                        window.location.href = response.url || '/dashboard';
                    }, 1000);
                } else if (response.status === 400) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                if (data && data.error === 'csrf_token_expired' && data.new_csrf_token) {
                    // Update CSRF token and retry
                    console.log('[FORM] CSRF token expired, refreshing and retrying');
                    const csrfInput = form.querySelector('input[name="csrf_token"]');
                    if (csrfInput) {
                        csrfInput.value = data.new_csrf_token;
                        form.dataset.csrfRetry = 'true';
                        form.submit(); // Retry submission
                    }
                } else if (data && data.message) {
                    // Show error message and restore button
                    console.log('[FORM] Error received:', data.message);
                    hideLoadingState(submitBtn, btnText);
                    showErrorNotification(data.message);
                }
            })
            .catch(error => {
                console.error('[FORM] Error:', error);
                // Fallback to normal form submission
                hideLoadingState(submitBtn, btnText);
                form.dataset.csrfRetry = 'true';
                form.submit();
            });
        });

        // Loading state functions
        function showLoadingState(btn, textElement) {
            const startTime = new Date();
            btn.classList.add('btn-loading');
            btn.disabled = true;
            textElement.textContent = 'Verifying...';

            // Show processing info
            const processingInfo = document.getElementById('processingInfo');
            if (processingInfo) {
                processingInfo.style.display = 'block';
            }

            // Store start time for debugging
            window.verificationStartTime = startTime;
            updateDebugInfo(`Verification started at: ${startTime.toLocaleTimeString()}`);

            // Update processing info with timer
            const timerInterval = setInterval(() => {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                if (processingInfo) {
                    processingInfo.innerHTML = `üîÑ Processing verification... ${elapsed}s elapsed`;
                }
                updateDebugInfo(`Verification started at: ${startTime.toLocaleTimeString()}\nElapsed: ${elapsed} seconds`);
            }, 1000);

            window.processingTimerInterval = timerInterval;
        }

        function hideLoadingState(btn, textElement) {
            btn.classList.remove('btn-loading');
            btn.disabled = false;
            textElement.textContent = 'Verify Code';

            // Reset submitting flag
            const form = document.querySelector('form');
            if (form) {
                delete form.dataset.submitting;
            }

            // Hide processing info
            const processingInfo = document.getElementById('processingInfo');
            if (processingInfo) {
                processingInfo.style.display = 'none';
            }

            // Clear timer
            if (window.processingTimerInterval) {
                clearInterval(window.processingTimerInterval);
            }

            // Update debug info with completion time
            if (window.verificationStartTime) {
                const elapsed = new Date() - window.verificationStartTime;
                updateDebugInfo(`Verification completed. Total time: ${(elapsed/1000).toFixed(2)} seconds`);
            }
        }

        function showSuccessState(btn, textElement) {
            btn.classList.remove('btn-loading');
            btn.style.background = '#4caf50';
            textElement.textContent = 'Success! Redirecting...';

            // Don't reset submitting flag on success - we want to prevent further submissions

            // Clear processing state
            const processingInfo = document.getElementById('processingInfo');
            if (processingInfo) {
                processingInfo.innerHTML = '‚úÖ Verification successful! Redirecting...';
                processingInfo.style.background = '#e8f5e8';
                processingInfo.style.color = '#2e7d32';
                processingInfo.style.borderColor = '#4caf50';
            }

            // Clear timer
            if (window.processingTimerInterval) {
                clearInterval(window.processingTimerInterval);
            }

            // Update debug info with success
            if (window.verificationStartTime) {
                const elapsed = new Date() - window.verificationStartTime;
                updateDebugInfo(`‚úÖ SUCCESS! Total time: ${(elapsed/1000).toFixed(2)} seconds`);
            }
        }

        function showErrorNotification(message) {
            // Create or update error notification
            let errorDiv = document.querySelector('.error-notification');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-error error-notification';
                const form = document.querySelector('form');
                form.insertBefore(errorDiv, form.firstChild);
            }
            errorDiv.textContent = message;
            errorDiv.scrollIntoView({ behavior: 'smooth' });

            // Update processing info with error
            const processingInfo = document.getElementById('processingInfo');
            if (processingInfo) {
                processingInfo.innerHTML = '‚ùå Verification failed. Please try again.';
                processingInfo.style.background = '#ffebee';
                processingInfo.style.color = '#c62828';
                processingInfo.style.borderColor = '#f44336';
            }
        }

        function updateDebugInfo(text) {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.style.display = 'block';
                debugDiv.textContent = text;
            }
        }
    </script>
</body>
</html>
