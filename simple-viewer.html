<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleDrive - File Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .file-card {
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .file-icon {
            font-size: 48px;
            margin-bottom: 15px;
            text-align: center;
        }
        .document-icon { color: #4285F4; }
        .photo-icon { color: #34A853; }
        .video-icon { color: #EA4335; }
        .audio-icon { color: #FBBC05; }
        .refresh-status {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
        }
        .auto-refresh-toggle {
            margin-left: 15px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">TeleDrive Files</h1>
        
        <div class="mb-3 d-flex align-items-center">
            <button id="refresh-btn" class="btn btn-primary">Refresh Files</button>
            <div class="form-check form-switch auto-refresh-toggle">
                <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                <label class="form-check-label" for="auto-refresh-toggle">T·ª± ƒë·ªông l√†m m·ªõi</label>
            </div>
            <span id="refresh-status" class="refresh-status"></span>
        </div>
        
        <div id="loading" class="text-center py-3">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Loading files...</p>
        </div>
        
        <div id="file-list" class="row"></div>
        
        <div id="no-files" class="alert alert-info d-none">
            No files found. Send files to your Telegram bot to get started.
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileList = document.getElementById('file-list');
            const loading = document.getElementById('loading');
            const noFiles = document.getElementById('no-files');
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshStatus = document.getElementById('refresh-status');
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            
            let currentFileCount = 0;
            let autoRefreshInterval = null;
            
            // Load files when page loads
            loadFiles();
            
            // Refresh button
            refreshBtn.addEventListener('click', function() {
                this.disabled = true;
                loadFiles().finally(() => {
                    this.disabled = false;
                });
            });

            // Auto refresh toggle
            autoRefreshToggle.addEventListener('change', toggleAutoRefresh);
            
            // Thi·∫øt l·∫≠p auto refresh
            function toggleAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                
                if (autoRefreshToggle.checked) {
                    // Ki·ªÉm tra m·ªói 10 gi√¢y
                    autoRefreshInterval = setInterval(checkForNewFiles, 10000);
                    refreshStatus.textContent = 'Auto refresh: ƒêang b·∫≠t';
                } else {
                    refreshStatus.textContent = 'Auto refresh: ƒê√£ t·∫Øt';
                }
            }
            
            // H√†m ki·ªÉm tra file m·ªõi
            async function checkForNewFiles() {
                try {
                    const response = await fetch('/data/files.json');
                    
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const files = await response.json();
                    
                    // N·∫øu s·ªë l∆∞·ª£ng file thay ƒë·ªïi, l√†m m·ªõi danh s√°ch
                    if (files && files.length !== currentFileCount) {
                        console.log('Ph√°t hi·ªán file m·ªõi, ƒëang l√†m m·ªõi...');
                        refreshBtn.disabled = true;
                        loadFiles().finally(() => {
                            refreshBtn.disabled = false;
                        });
                        return true;
                    }
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                                    now.getMinutes().toString().padStart(2, '0') + ':' + 
                                    now.getSeconds().toString().padStart(2, '0');
                    refreshStatus.textContent = `Ki·ªÉm tra l√∫c: ${timeStr}`;
                    return false;
                } catch (error) {
                    console.error('Error checking for new files:', error);
                    refreshStatus.textContent = `L·ªói: ${error.message}`;
                    return false;
                }
            }
            
            async function loadFiles() {
                loading.style.display = 'block';
                fileList.innerHTML = '';
                noFiles.classList.add('d-none');
                
                try {
                    // ƒê·ªçc tr·ª±c ti·∫øp t·ª´ file JSON
                    const response = await fetch('/data/files.json');
                    
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const files = await response.json();
                    
                    if (files && files.length > 0) {
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng file hi·ªán t·∫°i
                        currentFileCount = files.length;
                        
                        // Sort by newest first
                        files.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                        
                        files.forEach(file => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4 col-lg-3';
                            
                            let fileIcon = '';
                            if (file.fileType === 'document') {
                                fileIcon = '<div class="file-icon document-icon">üìÑ</div>';
                            } else if (file.fileType === 'photo') {
                                fileIcon = '<div class="file-icon photo-icon">üñºÔ∏è</div>';
                            } else if (file.fileType === 'video') {
                                fileIcon = '<div class="file-icon video-icon">üé¨</div>';
                            } else if (file.fileType === 'audio') {
                                fileIcon = '<div class="file-icon audio-icon">üéµ</div>';
                            } else {
                                fileIcon = '<div class="file-icon">üìÅ</div>';
                            }
                            
                            // X·ª≠ l√Ω hi·ªÉn th·ªã ·∫£nh n·∫øu l√† file ·∫£nh
                            let imagePreview = '';
                            if (file.fileType === 'photo' || (file.fileType === 'document' && 
                                (file.originalFileName.toLowerCase().endsWith('.jpg') || 
                                 file.originalFileName.toLowerCase().endsWith('.jpeg') || 
                                 file.originalFileName.toLowerCase().endsWith('.png')))) {
                                
                                const imgSrc = file.fileLink || file.filePath;
                                if (imgSrc) {
                                    imagePreview = `
                                        <div class="text-center mb-3">
                                            <img src="${imgSrc}" class="img-fluid" style="max-height: 150px; object-fit: contain;" 
                                                 alt="${file.originalFileName || file.fileName}"
                                                 onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
                                            <div style="display:none;">Image preview unavailable</div>
                                        </div>
                                    `;
                                    fileIcon = ''; // Kh√¥ng hi·ªÉn th·ªã icon n·∫øu c√≥ ·∫£nh
                                }
                            }
                            
                            col.innerHTML = `
                                <div class="card file-card h-100">
                                    <div class="card-body">
                                        ${fileIcon}
                                        ${imagePreview}
                                        <h5 class="card-title text-truncate" title="${file.originalFileName || file.fileName}">
                                            ${file.originalFileName || file.fileName}
                                        </h5>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                ${file.fileSize ? (file.fileSize / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown size'}
                                                <br>
                                                ${new Date(file.uploadDate).toLocaleString()}
                                            </small>
                                        </p>
                                        <div class="mt-3">
                                            <a href="${file.fileLink || file.filePath}" class="btn btn-primary btn-sm" 
                                               target="_blank" download="${file.originalFileName || file.fileName}">
                                                Download
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            fileList.appendChild(col);
                        });
                    } else {
                        noFiles.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Error loading files:', error);
                    fileList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Error loading files: ${error.message}
                            </div>
                        </div>
                    `;
                } finally {
                    loading.style.display = 'none';
                }
            }
            
            // B·∫Øt ƒë·∫ßu auto refresh n·∫øu ƒë∆∞·ª£c b·∫≠t
            toggleAutoRefresh();
            
            // Ki·ªÉm tra ngay khi trang t·∫£i xong
            setTimeout(checkForNewFiles, 1000);
        });
    </script>
</body>
</html> 