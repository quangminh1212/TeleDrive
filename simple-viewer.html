<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleDrive - File Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .file-card {
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .file-icon {
            font-size: 48px;
            margin-bottom: 15px;
            text-align: center;
        }
        .document-icon { color: #4285F4; }
        .photo-icon { color: #34A853; }
        .video-icon { color: #EA4335; }
        .audio-icon { color: #FBBC05; }
        .refresh-status {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
        }
        .auto-refresh-toggle {
            margin-left: 15px;
        }
        .progress {
            height: 5px;
        }
        .upload-card {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">TeleDrive Files</h1>
        
        <!-- Form Upload File -->
        <div class="card mb-4 upload-card">
            <div class="card-header">
                <h5 class="mb-0">Upload File</h5>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input class="form-control" type="file" id="file-input">
                    </div>
                    <div class="progress mb-3">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="upload-status" class="mb-3"></div>
                    <button type="button" id="upload-btn" class="btn btn-primary">Upload & ƒê·ªìng b·ªô v·ªõi Telegram</button>
                </form>
            </div>
        </div>
        
        <div class="mb-3 d-flex align-items-center">
            <button id="refresh-btn" class="btn btn-primary">Refresh Files</button>
            <div class="form-check form-switch auto-refresh-toggle">
                <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                <label class="form-check-label" for="auto-refresh-toggle">T·ª± ƒë·ªông l√†m m·ªõi</label>
            </div>
            <span id="refresh-status" class="refresh-status"></span>
        </div>
        
        <div id="loading" class="text-center py-3">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Loading files...</p>
        </div>
        
        <div id="file-list" class="row"></div>
        
        <div id="no-files" class="alert alert-info d-none">
            No files found. Send files to your Telegram bot to get started.
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileList = document.getElementById('file-list');
            const loading = document.getElementById('loading');
            const noFiles = document.getElementById('no-files');
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshStatus = document.getElementById('refresh-status');
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const progressBar = document.getElementById('progress-bar');
            const uploadStatus = document.getElementById('upload-status');
            
            let currentFileCount = 0;
            let autoRefreshInterval = null;
            
            // Load files when page loads
            loadFiles();
            
            // Refresh button
            refreshBtn.addEventListener('click', function() {
                this.disabled = true;
                loadFiles().finally(() => {
                    this.disabled = false;
                });
            });
            
            // Upload button
            uploadBtn.addEventListener('click', uploadFile);

            // Auto refresh toggle
            autoRefreshToggle.addEventListener('change', toggleAutoRefresh);
            
            // H√†m upload file
            async function uploadFile() {
                const file = fileInput.files[0];
                if (!file) {
                    showUploadStatus('Vui l√≤ng ch·ªçn file ƒë·ªÉ upload', 'danger');
                    return;
                }
                
                // Ki·ªÉm tra k√≠ch th∆∞·ªõc file
                if (file.size > 20 * 1024 * 1024) {
                    showUploadStatus('K√≠ch th∆∞·ªõc file v∆∞·ª£t qu√° gi·ªõi h·∫°n 20MB', 'danger');
                    return;
                }
                
                // Disable upload button v√† hi·ªÉn th·ªã tr·∫°ng th√°i
                uploadBtn.disabled = true;
                progressBar.style.width = '0%';
                showUploadStatus('ƒêang upload...', 'primary');
                
                // T·∫°o form data v√† th√™m file
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // Upload file v·ªõi progress
                    const xhr = new XMLHttpRequest();
                    
                    xhr.upload.addEventListener('progress', function(event) {
                        if (event.lengthComputable) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                            showUploadStatus('ƒêang upload: ' + Math.round(percentComplete) + '%', 'primary');
                        }
                    });
                    
                    xhr.addEventListener('load', function() {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            const response = JSON.parse(xhr.responseText);
                            showUploadStatus('Upload th√†nh c√¥ng! File ƒë√£ ƒë∆∞·ª£c l∆∞u v√† ƒë·ªìng b·ªô v·ªõi Telegram.', 'success');
                            
                            // Clear file input v√† l√†m m·ªõi danh s√°ch sau 1 gi√¢y
                            fileInput.value = '';
                            setTimeout(() => {
                                loadFiles();
                            }, 1000);
                        } else {
                            let errorMsg = 'L·ªói khi upload file';
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMsg = response.error || errorMsg;
                            } catch (e) {}
                            
                            showUploadStatus(errorMsg, 'danger');
                        }
                        uploadBtn.disabled = false;
                    });
                    
                    xhr.addEventListener('error', function() {
                        showUploadStatus('L·ªói k·∫øt n·ªëi khi upload file', 'danger');
                        uploadBtn.disabled = false;
                    });
                    
                    xhr.open('POST', '/api/upload');
                    xhr.send(formData);
                } catch (error) {
                    showUploadStatus('L·ªói: ' + error.message, 'danger');
                    uploadBtn.disabled = false;
                }
            }
            
            function showUploadStatus(message, type) {
                uploadStatus.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            }
            
            // Thi·∫øt l·∫≠p auto refresh
            function toggleAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                
                if (autoRefreshToggle.checked) {
                    // Ki·ªÉm tra m·ªói 10 gi√¢y
                    autoRefreshInterval = setInterval(checkForNewFiles, 10000);
                    refreshStatus.textContent = 'Auto refresh: ƒêang b·∫≠t';
                } else {
                    refreshStatus.textContent = 'Auto refresh: ƒê√£ t·∫Øt';
                }
            }
            
            // H√†m ki·ªÉm tra file m·ªõi
            async function checkForNewFiles() {
                try {
                    const response = await fetch('/api/files');
                    
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const files = await response.json();
                    
                    // N·∫øu s·ªë l∆∞·ª£ng file thay ƒë·ªïi, l√†m m·ªõi danh s√°ch
                    if (files && files.length !== currentFileCount) {
                        console.log('Ph√°t hi·ªán file m·ªõi, ƒëang l√†m m·ªõi...');
                        refreshBtn.disabled = true;
                        loadFiles().finally(() => {
                            refreshBtn.disabled = false;
                        });
                        return true;
                    }
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                                    now.getMinutes().toString().padStart(2, '0') + ':' + 
                                    now.getSeconds().toString().padStart(2, '0');
                    refreshStatus.textContent = `Ki·ªÉm tra l√∫c: ${timeStr}`;
                    return false;
                } catch (error) {
                    console.error('Error checking for new files:', error);
                    refreshStatus.textContent = `L·ªói: ${error.message}`;
                    return false;
                }
            }
            
            async function loadFiles() {
                loading.style.display = 'block';
                fileList.innerHTML = '';
                noFiles.classList.add('d-none');
                
                try {
                    // ƒê·ªçc tr·ª±c ti·∫øp t·ª´ file JSON
                    const response = await fetch('/api/files');
                    
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const files = await response.json();
                    
                    if (files && files.length > 0) {
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng file hi·ªán t·∫°i
                        currentFileCount = files.length;
                        
                        // Sort by newest first
                        files.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                        
                        files.forEach(file => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4 col-lg-3';
                            
                            let fileIcon = '';
                            if (file.fileType === 'document') {
                                fileIcon = '<div class="file-icon document-icon">üìÑ</div>';
                            } else if (file.fileType === 'photo') {
                                fileIcon = '<div class="file-icon photo-icon">üñºÔ∏è</div>';
                            } else if (file.fileType === 'video') {
                                fileIcon = '<div class="file-icon video-icon">üé¨</div>';
                            } else if (file.fileType === 'audio') {
                                fileIcon = '<div class="file-icon audio-icon">üéµ</div>';
                            } else {
                                fileIcon = '<div class="file-icon">üìÅ</div>';
                            }
                            
                            // X·ª≠ l√Ω hi·ªÉn th·ªã ·∫£nh n·∫øu l√† file ·∫£nh
                            let imagePreview = '';
                            if (file.fileType === 'photo' || (file.fileType === 'document' && 
                                (file.originalFileName.toLowerCase().endsWith('.jpg') || 
                                 file.originalFileName.toLowerCase().endsWith('.jpeg') || 
                                 file.originalFileName.toLowerCase().endsWith('.png')))) {
                                
                                const imgSrc = file.fileLink || file.filePath;
                                if (imgSrc) {
                                    imagePreview = `
                                        <div class="text-center mb-3">
                                            <img src="${imgSrc}" class="img-fluid" style="max-height: 150px; object-fit: contain;" 
                                                 alt="${file.originalFileName || file.fileName}"
                                                 onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
                                            <div style="display:none;">Image preview unavailable</div>
                                        </div>
                                    `;
                                    fileIcon = ''; // Kh√¥ng hi·ªÉn th·ªã icon n·∫øu c√≥ ·∫£nh
                                }
                            }
                            
                            // Hi·ªÉn th·ªã th√™m th√¥ng tin ƒë·ªìng b·ªô Telegram
                            let telegramInfo = '';
                            if (file.sentToTelegram === true) {
                                telegramInfo = '<span class="badge bg-success">ƒê√£ ƒë·ªìng b·ªô v·ªõi Telegram</span>';
                            } else if (file.sentToTelegram === false) {
                                telegramInfo = '<span class="badge bg-warning">Ch∆∞a ƒë·ªìng b·ªô v·ªõi Telegram</span>';
                            }
                            
                            col.innerHTML = `
                                <div class="card file-card h-100">
                                    <div class="card-body">
                                        ${fileIcon}
                                        ${imagePreview}
                                        <h5 class="card-title text-truncate" title="${file.originalFileName || file.fileName}">
                                            ${file.originalFileName || file.fileName}
                                        </h5>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                ${file.fileSize ? (file.fileSize / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown size'}
                                                <br>
                                                ${new Date(file.uploadDate).toLocaleString()}
                                            </small>
                                            <br>${telegramInfo}
                                        </p>
                                        <div class="mt-3 d-flex gap-2">
                                            <a href="${file.fileLink || file.filePath}" class="btn btn-primary btn-sm" 
                                               target="_blank" download="${file.originalFileName || file.fileName}">
                                                Download
                                            </a>
                                            <button class="btn btn-danger btn-sm" onclick="deleteFile('${file._id}')">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            fileList.appendChild(col);
                        });
                    } else {
                        noFiles.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Error loading files:', error);
                    fileList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Error loading files: ${error.message}
                            </div>
                        </div>
                    `;
                } finally {
                    loading.style.display = 'none';
                }
            }
            
            // B·∫Øt ƒë·∫ßu auto refresh n·∫øu ƒë∆∞·ª£c b·∫≠t
            toggleAutoRefresh();
            
            // Ki·ªÉm tra ngay khi trang t·∫£i xong
            setTimeout(checkForNewFiles, 1000);
            
            // Th√™m h√†m x√≥a file v√†o global scope
            window.deleteFile = async function(fileId) {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/files/${fileId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // L√†m m·ªõi danh s√°ch file
                        loadFiles();
                    } else {
                        alert('Kh√¥ng th·ªÉ x√≥a file. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    }
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert('L·ªói khi x√≥a file: ' + error.message);
                }
            };
        });
    </script>
</body>
</html> 