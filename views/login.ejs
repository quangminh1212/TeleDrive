<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng nhập | TeleDrive</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .error-message {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .success-message {
      color: #28a745;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .auth-code {
      font-family: monospace;
      font-size: 20px;
      background-color: #f8f9fa;
      padding: 8px 15px;
      border-radius: 4px;
      border: 1px dashed #6c757d;
      display: inline-block;
      margin: 10px 0;
      font-weight: bold;
    }

    .login-instructions {
      background-color: #f8f9fa;
      border-left: 4px solid #0088cc;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .login-instructions ol {
      margin: 10px 0 0 20px;
      padding: 0;
    }

    .login-instructions li {
      margin-bottom: 8px;
    }

    .auth-code-container {
      margin: 15px 0;
      display: none;
    }

    .login-methods {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <h1>TeleDrive</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">Trang chủ</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="login-container">
        <div class="login-box">
          <h2>Đăng nhập bằng Telegram</h2>
          <p>Quét mã QR hoặc nhấp vào nút đăng nhập để kết nối với tài khoản Telegram của bạn.</p>
          
          <div id="error-message" class="error-message"></div>
          <div id="success-message" class="success-message"></div>
          
          <div class="login-instructions">
            <strong>Hướng dẫn đăng nhập:</strong>
            <ol>
              <li>Quét mã QR hoặc nhấn vào nút "Đăng nhập với Telegram"</li>
              <li>Khi Telegram mở ra, nhấn vào nút <strong>START</strong> hoặc gõ lệnh <strong>/start</strong></li>
              <li>Nếu bot không phản hồi, hãy sao chép mã xác thực bên dưới và gõ: <br><code>/start login_[mã xác thực]</code></li>
              <li>Đợi hệ thống xác thực và chuyển hướng tự động</li>
            </ol>
          </div>

          <div id="auth-code-container" class="auth-code-container">
            <p><strong>Mã xác thực của bạn:</strong></p>
            <div id="auth-code" class="auth-code">Đang tạo mã...</div>
            <button id="copy-code" class="btn btn-secondary">Sao chép mã</button>
          </div>
          
          <div class="login-methods">
            <div id="qr-code-container">
              <div id="qr-code"></div>
              <p class="qr-help">Quét mã QR bằng ứng dụng Telegram</p>
            </div>
            
            <div class="login-separator">
              <span>hoặc</span>
            </div>
            
            <div class="login-button-container">
              <button id="telegram-login-button" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#ffffff">
                  <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.248l-1.43 6.69c-.104.487-.401.674-.813.419l-2.265-1.66-1.099 1.06c-.124.12-.226.22-.452.22l.163-2.279 4.151-3.738c.18-.163-.039-.253-.28-.09L8.36 11.883l-2.32-.726c-.506-.156-.514-.506.106-.748l9.073-3.5c.42-.156.785.096.646.6l-.052.027.001.012z"/>
                </svg>
                Đăng nhập với Telegram
              </button>
            </div>
          </div>
          
          <div id="login-status" class="login-status hidden">
            <div class="spinner"></div>
            <p>Đang xác thực...</p>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 TeleDrive. Tất cả các quyền được bảo lưu.</p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const qrCodeContainer = document.getElementById('qr-code');
      const telegramLoginButton = document.getElementById('telegram-login-button');
      const loginStatus = document.getElementById('login-status');
      const errorMessage = document.getElementById('error-message');
      const successMessage = document.getElementById('success-message');
      const authCodeContainer = document.getElementById('auth-code-container');
      const authCode = document.getElementById('auth-code');
      const copyCodeButton = document.getElementById('copy-code');
      
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
          errorMessage.style.display = 'none';
        }, 8000);
      }
      
      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 8000);
      }

      // Copy auth code to clipboard
      copyCodeButton.addEventListener('click', function() {
        const codeText = authCode.textContent;
        navigator.clipboard.writeText(codeText)
          .then(() => {
            showSuccess('Mã xác thực đã được sao chép!');
            copyCodeButton.textContent = 'Đã sao chép';
            setTimeout(() => {
              copyCodeButton.textContent = 'Sao chép mã';
            }, 3000);
          })
          .catch(err => {
            console.error('Lỗi khi sao chép: ', err);
            showError('Không thể sao chép mã. Vui lòng tự chép.');
          });
      });
      
      // Fetch login link
      fetch('/api/auth/login-link')
        .then(response => response.json())
        .then(data => {
          console.log('Login data:', data); // Log để debug
          
          if (!data.deepLink || !data.token) {
            showError('Không thể tạo liên kết đăng nhập, vui lòng thử lại sau.');
            return;
          }

          // Hiển thị mã xác thực
          const loginToken = data.token.slice(0, 16) + '...';
          authCode.textContent = data.token;
          authCodeContainer.style.display = 'block';
          
          // Generate QR code
          QRCode.toCanvas(qrCodeContainer, data.deepLink, {
            width: 200,
            margin: 2,
            color: {
              dark: '#0088cc',
              light: '#ffffff'
            }
          }).catch(err => {
            console.error('Error generating QR code:', err);
            qrCodeContainer.innerHTML = 'Lỗi tạo mã QR.';
          });
          
          // Set login button
          telegramLoginButton.addEventListener('click', function() {
            showSuccess('Đang mở Telegram... Nhấn nút START hoặc gõ lệnh /start khi Telegram mở');
            
            // Mở cửa sổ Telegram nhỏ hơn và ở giữa màn hình
            const width = 600;
            const height = 600;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            const options = `width=${width},height=${height},left=${left},top=${top}`;
            
            window.open(data.deepLink, '_blank', options);
            startLoginCheck(data.token);
          });
          
          // Start checking for login
          startLoginCheck(data.token);
        })
        .catch(error => {
          console.error('Error fetching login link:', error);
          showError('Lỗi kết nối đến máy chủ. Vui lòng thử lại sau.');
          qrCodeContainer.innerHTML = 'Lỗi tạo mã QR. Vui lòng thử lại sau.';
        });
      
      function startLoginCheck(token) {
        loginStatus.classList.remove('hidden');
        
        let attempts = 0;
        const maxAttempts = 60; // 3 minutes max (60 * 3s)
        
        // Check login status every 3 seconds
        const interval = setInterval(() => {
          attempts++;
          
          // Stop checking after max attempts
          if (attempts >= maxAttempts) {
            clearInterval(interval);
            loginStatus.innerHTML = '<p>Hết thời gian đăng nhập. Vui lòng làm mới trang để thử lại.</p>';
            showError('Hết thời gian đăng nhập. Vui lòng làm mới trang để thử lại.');
            return;
          }
          
          fetch(`/api/auth/check-login?token=${token}`)
            .then(response => response.json())
            .then(data => {
              console.log('Check login response:', data); // Log để debug
              
              if (data.loggedIn) {
                clearInterval(interval);
                loginStatus.innerHTML = '<p>Đăng nhập thành công! Đang chuyển hướng...</p>';
                showSuccess('Đăng nhập thành công! Đang chuyển hướng...');
                setTimeout(() => {
                  window.location.href = data.redirectUrl || '/dashboard';
                }, 1000);
              }
            })
            .catch(error => {
              console.error('Error checking login status:', error);
            });
        }, 3000);
      }
    });
  </script>
</body>
</html> 