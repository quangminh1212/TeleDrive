<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêƒÉng nh·∫≠p - TeleDrive</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script src="https://telegram.org/js/telegram-widget.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .login-container {
      max-width: 450px;
      width: 100%;
      padding: 20px;
    }
    .login-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-logo {
      font-size: 48px;
      color: #0d6efd;
      margin-bottom: 15px;
    }
    .login-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    .login-subtitle {
      color: #6c757d;
      font-size: 14px;
    }
    .login-btn {
      width: 100%;
      padding: 15px;
      font-weight: 500;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 10px;
      background-color: #0088cc;
      border-color: #0088cc;
    }
    .login-btn:hover {
      background-color: #0077b5;
      border-color: #0077b5;
    }
    .login-btn i {
      font-size: 20px;
      margin-right: 10px;
    }
    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #6c757d;
    }
    .alert {
      margin-bottom: 20px;
    }
    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #6c757d;
    }
    .divider::before, .divider::after {
      content: "";
      flex-grow: 1;
      background: rgba(0,0,0,0.1);
      height: 1px;
      margin: 0 10px;
    }
    .telegram-login-box {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    #telegram-login-teledrive_bot {
      overflow: hidden;
    }
    .step {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .step-number {
      background-color: #0088cc;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      margin-right: 10px;
    }
    .auth-method {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .auth-method-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #0088cc;
    }
    #manual-login-tab {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <i class="bi bi-telegram"></i>
        </div>
        <h4 class="login-title">TeleDrive</h4>
        <p class="login-subtitle">ƒêƒÉng nh·∫≠p b·∫±ng Telegram ƒë·ªÉ qu·∫£n l√Ω file c·ªßa b·∫°n</p>
      </div>
      
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <%= error %>
        </div>
      <% } %>
      
      <!-- Ph∆∞∆°ng th·ª©c 1: Widget Telegram -->
      <div class="auth-method">
        <div class="auth-method-title">
          <i class="bi bi-1-circle-fill me-1"></i> ƒêƒÉng nh·∫≠p nhanh
        </div>
        <p class="small mb-3">ƒêƒÉng nh·∫≠p tr·ª±c ti·∫øp b·∫±ng t√†i kho·∫£n Telegram c·ªßa b·∫°n:</p>
        <div class="telegram-login-box">
          <script async src="https://telegram.org/js/telegram-widget.js?22" 
            data-telegram-login="<%= botUsername %>" 
            data-size="large" 
            data-radius="10"
            data-auth-url="/api/auth/telegram/callback" 
            data-request-access="write">
          </script>
        </div>
      </div>
      
      <div class="divider">ho·∫∑c</div>
      
      <!-- Ph∆∞∆°ng th·ª©c 2: ƒêƒÉng nh·∫≠p th·ªß c√¥ng -->
      <div class="auth-method">
        <div class="auth-method-title">
          <i class="bi bi-2-circle-fill me-1"></i> ƒêƒÉng nh·∫≠p th·ªß c√¥ng
        </div>
        
        <!-- N√∫t ƒëƒÉng nh·∫≠p Telegram ƒë∆°n gi·∫£n -->
        <button id="telegramLoginBtn" class="btn btn-primary login-btn">
          <i class="bi bi-telegram"></i> K·∫øt n·ªëi v·ªõi Telegram Bot
        </button>
        
        <div id="instructions" class="mt-3" style="display: none;">
          <div class="step">
            <div class="step-number">1</div>
            <div>Nh·∫•n n√∫t <strong>START</strong> khi k·∫øt n·ªëi v·ªõi bot</div>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <div>Nh·∫≠p m√£ x√°c th·ª±c: <span id="authCode" class="fw-bold text-primary"></span></div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div>ƒê·ª£i h·ªá th·ªëng x√°c th·ª±c</div>
          </div>
          
          <div class="mt-3 p-2 bg-light rounded" id="authCodeDisplay">
            <p class="small mb-1">Sao ch√©p l·ªánh n√†y v√† g·ª≠i cho bot n·∫øu kh√¥ng t·ª± m·ªü ƒë∆∞·ª£c Telegram:</p>
            <div class="d-flex">
              <code class="flex-grow-1" id="authCommand" style="word-break: break-all;"></code>
              <button class="btn btn-sm btn-outline-secondary ms-2" id="copyAuthBtn" title="Sao ch√©p"><i class="bi bi-clipboard"></i></button>
            </div>
          </div>
        </div>
        <div id="statusMessage" class="mt-3 text-center" style="display: none;"></div>
      </div>
    </div>
    
    <div class="login-footer mt-3">
      <p class="mb-0">
        <i class="bi bi-info-circle me-1"></i>
        Bot Telegram: @<%= botUsername %>
      </p>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const loginBtn = document.getElementById('telegramLoginBtn');
      const statusMessage = document.getElementById('statusMessage');
      const instructions = document.getElementById('instructions');
      const authCodeDisplay = document.getElementById('authCodeDisplay');
      const authCommand = document.getElementById('authCommand');
      const authCodeSpan = document.getElementById('authCode');
      const copyAuthBtn = document.getElementById('copyAuthBtn');
      let authCode = '';
      let checkInterval = null;
      
      // X·ª≠ l√Ω sao ch√©p m√£ x√°c th·ª±c
      copyAuthBtn.addEventListener('click', function() {
        const commandText = authCommand.textContent;
        navigator.clipboard.writeText(commandText).then(() => {
          copyAuthBtn.innerHTML = '<i class="bi bi-check"></i>';
          setTimeout(() => {
            copyAuthBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
          }, 2000);
        }).catch(err => {
          console.error('L·ªói khi sao ch√©p v√†o clipboard:', err);
        });
      });
      
      // Ki·ªÉm tra tr·∫°ng th√°i x√°c th·ª±c
      async function checkAuthStatus() {
        try {
          if (!authCode) return;
          
          console.log('ƒêang ki·ªÉm tra m√£ x√°c th·ª±c:', authCode);
          
          // S·ª≠ d·ª•ng API check-status ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i x√°c th·ª±c
          const response = await fetch('/api/auth/check-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ authCode: authCode })
          });
          
          if (!response.ok) {
            console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i:', response.status);
            return;
          }
          
          const data = await response.json();
          console.log('K·∫øt qu·∫£ ki·ªÉm tra tr·∫°ng th√°i:', data);
          
          if (data.success) {
            // X√°c th·ª±c th√†nh c√¥ng
            clearInterval(checkInterval);
            showStatus('‚úÖ X√°c th·ª±c th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', 'success');
            
            // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ch√≠nh
            setTimeout(() => {
              window.location.href = '/';
            }, 1500);
          } else if (data.status === 'pending') {
            // ƒêang ƒë·ª£i x√°c th·ª±c
            showStatus('‚è≥ ƒêang ƒë·ª£i x√°c th·ª±c t·ª´ Telegram... Vui l√≤ng g·ª≠i m√£ x√°c th·ª±c cho bot.', 'info');
          } else if (data.status === 'not_found') {
            // M√£ kh√¥ng t·ªìn t·∫°i
            showStatus('‚ö†Ô∏è M√£ x√°c th·ª±c kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.', 'warning');
          } else {
            showStatus('‚è≥ ƒêang ki·ªÉm tra x√°c th·ª±c...', 'info');
          }
        } catch (error) {
          console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i:', error);
        }
      }
      
      // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p Telegram
      loginBtn.addEventListener('click', async function() {
        try {
          loginBtn.disabled = true;
          loginBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ƒêang k·∫øt n·ªëi...';
          
          // L·∫•y m√£ x√°c th·ª±c t·ª´ server
          const authResponse = await fetch('/api/auth/get-auth-code');
          const authData = await authResponse.json();
          
          if (!authData.success) {
            showStatus('‚ùå Kh√¥ng th·ªÉ t·∫°o m√£ x√°c th·ª±c. Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="bi bi-telegram"></i> K·∫øt n·ªëi v·ªõi Telegram Bot';
            return;
          }
          
          // L∆∞u m√£ x√°c th·ª±c ƒë·ªÉ ki·ªÉm tra sau
          authCode = authData.authCode;
          
          // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n v√† m√£
          instructions.style.display = 'block';
          authCodeSpan.textContent = authCode;
          
          // Hi·ªÉn th·ªã m√£ x√°c th·ª±c ƒë·ªÉ sao ch√©p
          authCommand.textContent = `/auth ${authCode}`;
          
          // M·ªü tab m·ªõi ƒë·ªÉ x√°c th·ª±c
          const botUsername = '<%= botUsername %>';
          const authUrl = `tg://resolve?domain=${botUsername}`;
          window.open(authUrl, '_blank');
          
          // N·∫øu kh√¥ng m·ªü ƒë∆∞·ª£c v·ªõi protocol tg://, th·ª≠ v·ªõi https://t.me/
          setTimeout(() => {
            // Th·ª≠ m·ªü l·∫°i n·∫øu ch∆∞a m·ªü ƒë∆∞·ª£c
            const fallbackUrl = `https://t.me/${botUsername}`;
            const fallbackWindow = window.open(fallbackUrl, '_blank');
            
            if (!fallbackWindow || fallbackWindow.closed || typeof fallbackWindow.closed === 'undefined') {
              // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n sao ch√©p l·ªánh n·∫øu kh√¥ng m·ªü ƒë∆∞·ª£c
              showStatus(`Kh√¥ng th·ªÉ m·ªü Telegram t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p m√£ x√°c th·ª±c v√† g·ª≠i cho @${botUsername}`, 'warning');
            }
          }, 1000);
          
          // Hi·ªÉn th·ªã tr·∫°ng th√°i v√† b·∫Øt ƒë·∫ßu ki·ªÉm tra
          showStatus('üîÑ ƒêang ƒë·ª£i x√°c th·ª±c t·ª´ Telegram...', 'info');
          
          // B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i x√°c th·ª±c
          if (checkInterval) {
            clearInterval(checkInterval);
          }
          
          // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu ki·ªÉm tra ƒë·ªÉ ƒë·∫£m b·∫£o bot ƒë√£ nh·∫≠n ƒë∆∞·ª£c y√™u c·∫ßu
          setTimeout(() => {
            // Ki·ªÉm tra tr·∫°ng th√°i ngay l·∫≠p t·ª©c tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu interval
            checkAuthStatus();
            checkInterval = setInterval(checkAuthStatus, 3000);
          }, 2000);
        } catch (error) {
          console.error('L·ªói khi b·∫Øt ƒë·∫ßu x√°c th·ª±c:', error);
          showStatus('‚ùå ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
          loginBtn.disabled = false;
          loginBtn.innerHTML = '<i class="bi bi-telegram"></i> K·∫øt n·ªëi v·ªõi Telegram Bot';
        }
      });
      
      // Hi·ªÉn th·ªã th√¥ng b√°o tr·∫°ng th√°i
      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';
        
        // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c class m√†u
        statusMessage.classList.remove('text-danger', 'text-success', 'text-info', 'text-warning');
        
        // Th√™m class t∆∞∆°ng ·ª©ng
        switch (type) {
          case 'danger':
            statusMessage.classList.add('text-danger');
            break;
          case 'success':
            statusMessage.classList.add('text-success');
            break;
          case 'info':
            statusMessage.classList.add('text-info');
            break;
          case 'warning':
            statusMessage.classList.add('text-warning');
            break;
        }
      }
    });
  </script>
</body>
</html> 