<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng nhập | TeleDrive</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <h1>TeleDrive</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">Trang chủ</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="login-container">
        <div class="login-box">
          <h2>Đăng nhập bằng Telegram</h2>
          <p>Quét mã QR bên dưới hoặc nhấp vào nút đăng nhập để tiếp tục.</p>
          
          <div class="login-methods">
            <div id="qr-code-container">
              <div id="qr-code"></div>
              <p class="qr-help">Quét mã QR bằng ứng dụng Telegram</p>
            </div>
            
            <div class="login-separator">
              <span>hoặc</span>
            </div>
            
            <div class="login-button-container">
              <button id="telegram-login-button" class="btn btn-primary">
                <img src="/img/telegram-logo.png" alt="Telegram logo">
                Đăng nhập với Telegram
              </button>
            </div>
          </div>
          
          <div id="login-status" class="login-status hidden">
            <div class="spinner"></div>
            <p>Đang xác thực...</p>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 TeleDrive. Tất cả các quyền được bảo lưu.</p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const qrCodeContainer = document.getElementById('qr-code');
      const telegramLoginButton = document.getElementById('telegram-login-button');
      const loginStatus = document.getElementById('login-status');
      
      // Fetch login link
      fetch('/api/auth/login-link')
        .then(response => response.json())
        .then(data => {
          // Generate QR code
          QRCode.toCanvas(qrCodeContainer, data.loginUrl, {
            width: 200,
            margin: 2,
            color: {
              dark: '#0088cc',
              light: '#ffffff'
            }
          });
          
          // Set login button
          telegramLoginButton.addEventListener('click', function() {
            window.open(data.loginUrl, '_blank');
            startLoginCheck(data.token);
          });
          
          // Start checking for login
          startLoginCheck(data.token);
        })
        .catch(error => {
          console.error('Error fetching login link:', error);
          qrCodeContainer.innerHTML = 'Lỗi tạo mã QR. Vui lòng thử lại sau.';
        });
      
      function startLoginCheck(token) {
        loginStatus.classList.remove('hidden');
        
        // Check login status every 3 seconds
        const interval = setInterval(() => {
          fetch(`/api/auth/check-login?token=${token}`)
            .then(response => response.json())
            .then(data => {
              if (data.loggedIn) {
                clearInterval(interval);
                loginStatus.innerHTML = '<p>Đăng nhập thành công! Đang chuyển hướng...</p>';
                window.location.href = data.redirectUrl || '/dashboard';
              }
            })
            .catch(error => {
              console.error('Error checking login status:', error);
            });
        }, 3000);
      }
    });
  </script>
</body>
</html> 