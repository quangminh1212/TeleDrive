<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đăng nhập | TeleDrive</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .error-message {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .success-message {
      color: #28a745;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <h1>TeleDrive</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">Trang chủ</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="login-container">
        <div class="login-box">
          <h2>Đăng nhập bằng Telegram</h2>
          <p>Quét mã QR bên dưới hoặc nhấp vào nút đăng nhập để tiếp tục.</p>
          
          <div id="error-message" class="error-message"></div>
          <div id="success-message" class="success-message"></div>
          
          <div class="login-methods">
            <div id="qr-code-container">
              <div id="qr-code"></div>
              <p class="qr-help">Quét mã QR bằng ứng dụng Telegram</p>
            </div>
            
            <div class="login-separator">
              <span>hoặc</span>
            </div>
            
            <div class="login-button-container">
              <button id="telegram-login-button" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#ffffff">
                  <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.248l-1.43 6.69c-.104.487-.401.674-.813.419l-2.265-1.66-1.099 1.06c-.124.12-.226.22-.452.22l.163-2.279 4.151-3.738c.18-.163-.039-.253-.28-.09L8.36 11.883l-2.32-.726c-.506-.156-.514-.506.106-.748l9.073-3.5c.42-.156.785.096.646.6l-.052.027.001.012z"/>
                </svg>
                Đăng nhập với Telegram
              </button>
            </div>
          </div>
          
          <div id="login-status" class="login-status hidden">
            <div class="spinner"></div>
            <p>Đang xác thực...</p>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 TeleDrive. Tất cả các quyền được bảo lưu.</p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const qrCodeContainer = document.getElementById('qr-code');
      const telegramLoginButton = document.getElementById('telegram-login-button');
      const loginStatus = document.getElementById('login-status');
      const errorMessage = document.getElementById('error-message');
      const successMessage = document.getElementById('success-message');
      
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
          errorMessage.style.display = 'none';
        }, 5000);
      }
      
      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 5000);
      }
      
      // Fetch login link
      fetch('/api/auth/login-link')
        .then(response => response.json())
        .then(data => {
          console.log('Login data:', data); // Log để debug
          
          if (!data.deepLink || !data.token) {
            showError('Không thể tạo liên kết đăng nhập, vui lòng thử lại sau.');
            return;
          }
          
          // Generate QR code
          QRCode.toCanvas(qrCodeContainer, data.deepLink, {
            width: 200,
            margin: 2,
            color: {
              dark: '#0088cc',
              light: '#ffffff'
            }
          }).catch(err => {
            console.error('Error generating QR code:', err);
            qrCodeContainer.innerHTML = 'Lỗi tạo mã QR.';
          });
          
          // Set login button
          telegramLoginButton.addEventListener('click', function() {
            showSuccess('Đang mở Telegram...');
            window.open(data.deepLink, '_blank');
            startLoginCheck(data.token);
          });
          
          // Start checking for login
          startLoginCheck(data.token);
        })
        .catch(error => {
          console.error('Error fetching login link:', error);
          showError('Lỗi kết nối đến máy chủ. Vui lòng thử lại sau.');
          qrCodeContainer.innerHTML = 'Lỗi tạo mã QR. Vui lòng thử lại sau.';
        });
      
      function startLoginCheck(token) {
        loginStatus.classList.remove('hidden');
        
        let attempts = 0;
        const maxAttempts = 60; // 3 minutes max (60 * 3s)
        
        // Check login status every 3 seconds
        const interval = setInterval(() => {
          attempts++;
          
          // Stop checking after max attempts
          if (attempts >= maxAttempts) {
            clearInterval(interval);
            loginStatus.innerHTML = '<p>Hết thời gian đăng nhập. Vui lòng làm mới trang để thử lại.</p>';
            showError('Hết thời gian đăng nhập. Vui lòng làm mới trang để thử lại.');
            return;
          }
          
          fetch(`/api/auth/check-login?token=${token}`)
            .then(response => response.json())
            .then(data => {
              console.log('Check login response:', data); // Log để debug
              
              if (data.loggedIn) {
                clearInterval(interval);
                loginStatus.innerHTML = '<p>Đăng nhập thành công! Đang chuyển hướng...</p>';
                showSuccess('Đăng nhập thành công! Đang chuyển hướng...');
                setTimeout(() => {
                  window.location.href = data.redirectUrl || '/dashboard';
                }, 1000);
              }
            })
            .catch(error => {
              console.error('Error checking login status:', error);
            });
        }, 3000);
      }
    });
  </script>
</body>
</html> 