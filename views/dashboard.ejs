<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeleDrive - Qu·∫£n l√Ω File</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    :root {
      --primary-color: #0088cc;
      --primary-dark: #006699;
      --primary-light: #00aaff;
      --accent-color: #fe9800;
      --text-color: #202324;
      --text-secondary: #666666;
      --background-color: #f7f9fb;
      --card-bg: #ffffff;
      --border-color: #e1e4e8;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 20px;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-color);
      background-color: var(--background-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .dashboard {
      display: flex;
      min-height: calc(100vh - 140px);
    }
    
    /* Header styles */
    header {
      background-color: var(--card-bg);
      box-shadow: var(--shadow-sm);
      padding: 0.8rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
    }
    
    .logo h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }
    
    nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
      gap: 1.5rem;
    }
    
    nav ul li a {
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0.5rem 0;
      transition: color 0.2s;
      position: relative;
    }
    
    nav ul li a::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: var(--primary-color);
      transition: width 0.3s ease;
    }
    
    nav ul li a:hover::after,
    nav ul li a.active::after {
      width: 100%;
    }
    
    nav ul li a:hover,
    nav ul li a.active {
      color: var(--primary-color);
    }
    
    /* Sidebar styles */
    .sidebar {
      width: 260px;
      background-color: var(--card-bg);
      border-right: 1px solid var(--border-color);
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: sticky;
      top: 61px;
      height: calc(100vh - 61px);
      overflow-y: auto;
    }
    
    .user-info {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .user-info h3 {
      font-size: 1.1rem;
      margin: 0;
      font-weight: 600;
      color: var(--text-color);
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu li {
      margin-bottom: 0.5rem;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--text-secondary);
      padding: 0.8rem 1rem;
      border-radius: var(--radius-md);
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .sidebar-menu a:hover {
      background-color: rgba(0, 136, 204, 0.08);
      color: var(--primary-color);
    }
    
    .sidebar-menu a.active {
      background-color: rgba(0, 136, 204, 0.12);
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .sidebar-menu .icon {
      margin-right: 12px;
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    .storage-info {
      background-color: #f9f9fb;
      border-radius: var(--radius-md);
      padding: 1.2rem;
      margin-top: 1.5rem;
    }
    
    .storage-info h4 {
      font-size: 0.9rem;
      margin: 0 0 0.8rem 0;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .storage-bar {
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.8rem;
    }
    
    .storage-used {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
      width: 0%;
      border-radius: 10px;
      transition: width 1s ease;
    }
    
    .storage-info p {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin: 0;
    }
    
    /* Main content styles */
    .main-content {
      flex: 1;
      padding: 1.5rem;
      transition: margin-left 0.3s ease;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .dashboard-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    /* File grid styles */
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.2rem;
    }
    
    .file-card {
      background-color: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      text-align: center;
      transition: all 0.3s;
      position: relative;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
    }
    
    .file-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-4px);
    }
    
    .file-icon {
      font-size: 40px;
      margin-bottom: 0.8rem;
      color: var(--primary-color);
    }
    
    .file-name {
      font-weight: 600;
      margin-bottom: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 0.9rem;
    }
    
    .file-size {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .upload-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: var(--radius-md);
      text-decoration: none;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(0, 136, 204, 0.25);
    }
    
    .upload-btn:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
    }
    
    /* Empty state styles */
    .empty-state {
      text-align: center;
      padding: 3rem;
      background-color: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }
    
    .empty-state .icon {
      font-size: 5rem;
      color: #ddd;
      margin-bottom: 1.5rem;
    }
    
    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
    }
    
    .empty-state p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Upload Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 2rem;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h3 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
    }
    
    .close {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: 300;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .close:hover {
      color: var(--text-color);
    }
    
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
      background-color: var(--background-color);
    }
    
    .upload-area:hover {
      border-color: var(--primary-color);
      background-color: rgba(0, 136, 204, 0.05);
    }
    
    .upload-area p {
      color: var(--text-secondary);
      margin-bottom: 0;
    }
    
    .file-input {
      display: none;
    }
    
    .upload-progress {
      margin-top: 1rem;
      display: none;
    }
    
    .progress-bar {
      height: 6px;
      background-color: #f3f3f3;
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-bottom: 0.8rem;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
      width: 0%;
      border-radius: var(--radius-lg);
      transition: width 0.3s;
    }
    
    /* File Actions */
    .file-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: none;
      gap: 5px;
    }
    
    .file-card:hover .file-actions {
      display: flex;
    }
    
    .file-action {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #f3f3f3;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      color: var(--text-secondary);
    }
    
    .file-action:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }
    
    /* Loading spinner */
    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
    }
    
    .spinner {
      border: 3px solid rgba(0, 136, 204, 0.1);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Settings styles */
    .settings-section {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    
    .settings-title {
      font-size: 1.2rem;
      margin-bottom: 1.2rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 1.2rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    
    .checkbox-group input {
      margin-right: 10px;
      accent-color: var(--primary-color);
    }
    
    .btn {
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: 0 2px 8px rgba(0, 136, 204, 0.25);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff4b4b, #d90429);
      color: white;
      box-shadow: 0 2px 8px rgba(217, 4, 41, 0.25);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #d90429, #ff4b4b);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(217, 4, 41, 0.3);
    }
    
    /* Footer styles */
    footer {
      background-color: var(--card-bg);
      border-top: 1px solid var(--border-color);
      padding: 1.5rem;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      .dashboard {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        position: static;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
      
      .sidebar-menu a {
        padding: 0.7rem;
      }
      
      header {
        flex-direction: column;
        padding: 1rem;
      }
      
      nav ul {
        margin-top: 1rem;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .file-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <h1>TeleDrive</h1>
    </div>
    <nav>
      <ul>
        <li><a href="/">Trang ch·ªß</a></li>
        <li><a href="/dashboard" class="active">Qu·∫£n l√Ω File</a></li>
        <li><a href="/logout">ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </nav>
  </header>

  <main class="dashboard">
    <div class="sidebar">
      <div class="user-info">
        <h3>Xin ch√†o, <%= user.firstName %></h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/dashboard" class="<%= !locals.activeType ? 'active' : '' %>"><span class="icon"><i class="far fa-folder"></i></span> T·∫•t c·∫£ file</a></li>
        <li><a href="/dashboard/photos" class="<%= locals.activeType === 'photos' ? 'active' : '' %>"><span class="icon"><i class="far fa-image"></i></span> H√¨nh ·∫£nh</a></li>
        <li><a href="/dashboard/videos" class="<%= locals.activeType === 'videos' ? 'active' : '' %>"><span class="icon"><i class="far fa-file-video"></i></span> Video</a></li>
        <li><a href="/dashboard/documents" class="<%= locals.activeType === 'documents' ? 'active' : '' %>"><span class="icon"><i class="far fa-file-alt"></i></span> T√†i li·ªáu</a></li>
        <li><a href="/dashboard/audio" class="<%= locals.activeType === 'audio' ? 'active' : '' %>"><span class="icon"><i class="far fa-file-audio"></i></span> √Çm thanh</a></li>
        <li><a href="/dashboard/trash" class="<%= locals.activeType === 'trash' ? 'active' : '' %>"><span class="icon"><i class="far fa-trash-alt"></i></span> Th√πng r√°c</a></li>
        <li><a href="/dashboard/settings" class="<%= locals.activeType === 'settings' ? 'active' : '' %>"><span class="icon"><i class="fas fa-cog"></i></span> C√†i ƒë·∫∑t</a></li>
      </ul>
      
      <div class="storage-info">
        <h4>Dung l∆∞·ª£ng l∆∞u tr·ªØ</h4>
        <div class="storage-bar">
          <div class="storage-used" style="width: <% var percentage = typeof user.getStoragePercentage === 'function' ? user.getStoragePercentage() : (user.storagePercentage || 0); %><%= percentage %>%"></div>
        </div>
        <p>ƒê√£ s·ª≠ d·ª•ng: <%= typeof user.getStoragePercentage === 'function' ? user.getStoragePercentage() : (user.storagePercentage || 0) %>%</p>
      </div>
    </div>
    
    <div class="main-content">
      <% if (locals.activeType === 'settings') { %>
        <!-- Settings page -->
        <div class="dashboard-header">
          <h2>C√†i ƒë·∫∑t</h2>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-title">T√†i kho·∫£n</h3>
          <div class="form-group">
            <label>T√™n c·ªßa b·∫°n</label>
            <input type="text" class="form-control" value="<%= user.firstName %> <%= user.lastName || '' %>" disabled>
          </div>
          <div class="form-group">
            <label>Lo·∫°i t√†i kho·∫£n</label>
            <input type="text" class="form-control" value="<%= user.isPremium ? 'Premium' : 'Mi·ªÖn ph√≠' %>" disabled>
          </div>
          <% if (!user.isPremium) { %>
            <p>N√¢ng c·∫•p l√™n t√†i kho·∫£n Premium ƒë·ªÉ c√≥ th√™m dung l∆∞·ª£ng l∆∞u tr·ªØ.</p>
            <button class="btn btn-primary" id="upgrade-btn">N√¢ng c·∫•p l√™n Premium</button>
          <% } %>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-title">T√πy ch·ªçn</h3>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="auto-delete-downloads" <%= user.settings && user.settings.autoDeleteDownloads ? 'checked' : '' %>>
            <label for="auto-delete-downloads">T·ª± ƒë·ªông x√≥a file sau khi t·∫£i xu·ªëng</label>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="notifications" <%= user.settings && user.settings.notificationsEnabled ? 'checked' : '' %>>
            <label for="notifications">B·∫≠t th√¥ng b√°o</label>
          </div>
          <button class="btn btn-primary" id="save-settings">L∆∞u c√†i ƒë·∫∑t</button>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-title">Nguy hi·ªÉm</h3>
          <p>H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ c√°c file c·ªßa b·∫°n.</p>
          <button class="btn btn-danger" id="delete-all-files">X√≥a t·∫•t c·∫£ file</button>
        </div>
      <% } else { %>
        <!-- File listing page -->
        <div class="dashboard-header">
          <% if (locals.activeType === 'photos') { %>
            <h2><i class="far fa-image"></i> H√¨nh ·∫£nh</h2>
          <% } else if (locals.activeType === 'videos') { %>
            <h2><i class="far fa-file-video"></i> Video</h2>
          <% } else if (locals.activeType === 'documents') { %>
            <h2><i class="far fa-file-alt"></i> T√†i li·ªáu</h2>
          <% } else if (locals.activeType === 'audio') { %>
            <h2><i class="far fa-file-audio"></i> √Çm thanh</h2>
          <% } else if (locals.activeType === 'trash') { %>
            <h2><i class="far fa-trash-alt"></i> Th√πng r√°c</h2>
          <% } else { %>
            <h2><i class="far fa-folder"></i> T·∫•t c·∫£ file</h2>
          <% } %>
          
          <% if (locals.activeType !== 'trash' && locals.activeType !== 'settings') { %>
            <a href="#" class="upload-btn" id="upload-btn">
              <i class="fas fa-upload"></i> T·∫£i l√™n
            </a>
          <% } else if (locals.activeType === 'trash') { %>
            <button class="btn btn-danger" id="empty-trash">
              <i class="fas fa-trash-alt"></i> D·ªçn th√πng r√°c
            </button>
          <% } %>
        </div>
        
        <!-- Loading state -->
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i...</p>
        </div>
        
        <!-- Empty state - initially hidden, will show if no files -->
        <div class="empty-state" id="empty-state" style="display: none;">
          <div class="icon">
            <% if (locals.activeType === 'photos') { %>
              <i class="far fa-image"></i>
            <% } else if (locals.activeType === 'videos') { %>
              <i class="far fa-file-video"></i>
            <% } else if (locals.activeType === 'documents') { %>
              <i class="far fa-file-alt"></i>
            <% } else if (locals.activeType === 'audio') { %>
              <i class="far fa-file-audio"></i>
            <% } else if (locals.activeType === 'trash') { %>
              <i class="far fa-trash-alt"></i>
            <% } else { %>
              <i class="far fa-folder-open"></i>
            <% } %>
          </div>
          <% if (locals.activeType === 'trash') { %>
            <h3>Th√πng r√°c tr·ªëng</h3>
            <p>Kh√¥ng c√≥ file n√†o trong th√πng r√°c</p>
          <% } else { %>
            <h3>Ch∆∞a c√≥ file n√†o</h3>
            <p>H√£y t·∫£i l√™n file ƒë·∫ßu ti√™n c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng TeleDrive</p>
            <a href="#" class="upload-btn" id="empty-upload-btn">
              <i class="fas fa-upload"></i> T·∫£i l√™n ngay
            </a>
          <% } %>
        </div>
        
        <!-- File grid - initially hidden, will be populated with files -->
        <div class="file-grid" id="file-grid">
          <!-- Files will be rendered here via JavaScript -->
        </div>
      <% } %>
    </div>
  </main>

  <footer>
    <p>&copy; <%= new Date().getFullYear() %> TeleDrive. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
  </footer>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>T·∫£i l√™n file</h3>
        <span class="close">&times;</span>
      </div>
      <div class="upload-area" id="drop-area">
        <p><i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 0.8rem; display: block; color: var(--primary-color);"></i>
        K√©o v√† th·∫£ file v√†o ƒë√¢y ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file</p>
        <input type="file" id="file-input" class="file-input">
      </div>
      <div id="upload-progress" class="upload-progress">
        <p id="upload-status">ƒêang t·∫£i l√™n...</p>
        <div class="progress-bar">
          <div class="progress" id="progress-bar"></div>
        </div>
      </div>
      <button id="upload-submit" class="btn btn-primary" style="width: 100%;">T·∫£i l√™n</button>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fileGrid = document.getElementById('file-grid');
      const emptyState = document.getElementById('empty-state');
      const loadingElement = document.getElementById('loading');
      const uploadBtn = document.getElementById('upload-btn');
      const emptyUploadBtn = document.getElementById('empty-upload-btn');
      const uploadModal = document.getElementById('upload-modal');
      const closeBtn = document.querySelector('.close');
      const dropArea = document.getElementById('drop-area');
      const fileInput = document.getElementById('file-input');
      const uploadSubmit = document.getElementById('upload-submit');
      const progressBar = document.getElementById('progress-bar');
      const uploadProgress = document.getElementById('upload-progress');
      const uploadStatus = document.getElementById('upload-status');
      
      let currentFiles = [];
      
      // Get current page type from URL or default to 'all'
      const currentPath = window.location.pathname;
      let fileType = 'all';
      
      if (currentPath.includes('/photos')) fileType = 'photos';
      else if (currentPath.includes('/videos')) fileType = 'videos';
      else if (currentPath.includes('/documents')) fileType = 'documents';
      else if (currentPath.includes('/audio')) fileType = 'audio';
      else if (currentPath.includes('/trash')) fileType = 'trash';
      else if (currentPath.includes('/settings')) fileType = 'settings';
      
      // Don't load files on settings page
      if (fileType !== 'settings') {
        // Show loading state
        loadingElement.style.display = 'block';
        
        // Fetch files from API based on the current page
        fetchFiles(fileType);
      }
      
      // Open the upload modal
      function openUploadModal() {
        uploadModal.style.display = 'block';
        
        // Reset upload form
        fileInput.value = '';
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
        uploadStatus.textContent = 'ƒêang t·∫£i l√™n...';
      }
      
      // Close the upload modal
      function closeUploadModal() {
        uploadModal.style.display = 'none';
      }
      
      // Upload button click event
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function(e) {
          e.preventDefault();
          openUploadModal();
        });
      }
      
      // Empty state upload button click event
      if (emptyUploadBtn) {
        emptyUploadBtn.addEventListener('click', function(e) {
          e.preventDefault();
          openUploadModal();
        });
      }
      
      // Close button click event
      if (closeBtn) {
        closeBtn.addEventListener('click', closeUploadModal);
      }
      
      // Click outside modal to close
      window.addEventListener('click', function(e) {
        if (e.target === uploadModal) {
          closeUploadModal();
        }
      });
      
      // Drop area click event
      if (dropArea) {
        dropArea.addEventListener('click', function() {
          fileInput.click();
        });
      }
      
      // Handle file selection
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            dropArea.innerHTML = `<p>File: ${fileName}</p>`;
          }
        });
      }
      
      // Submit upload form
      if (uploadSubmit) {
        uploadSubmit.addEventListener('click', function() {
          if (fileInput.files.length === 0) {
            alert('Vui l√≤ng ch·ªçn file ƒë·ªÉ t·∫£i l√™n');
            return;
          }
          
          const file = fileInput.files[0];
          
          // Show progress
          uploadProgress.style.display = 'block';
          uploadSubmit.disabled = true;
          
          // Create form data
          const formData = new FormData();
          formData.append('file', file);
          
          // T·∫£i file l√™n s·ª≠ d·ª•ng API th·∫≠t
          uploadFile(formData);
        });
      }
      
      // Fetch files from API
      function fetchFiles(type) {
        // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
        loadingElement.style.display = 'block';
        emptyState.style.display = 'none';
        fileGrid.style.display = 'none';
        
        // C·∫•u h√¨nh tham s·ªë t√¨m ki·∫øm
        const options = {
          limit: 50
        };
        
        if (type === 'photos') {
          options.type = 'image';
        } else if (type === 'videos') {
          options.type = 'video';
        } else if (type === 'documents') {
          options.type = 'document';
        } else if (type === 'audio') {
          options.type = 'audio';
        } else if (type === 'trash') {
          options.trash = true;
        }
        
        // S·ª≠ d·ª•ng FileAPI ƒë√£ ƒë·ªãnh nghƒ©a trong main.js
        FileAPI.listFiles(options)
          .then(response => {
            // ·∫®n tr·∫°ng th√°i loading
            loadingElement.style.display = 'none';
            
            if (response.files && response.files.length > 0) {
              currentFiles = response.files;
              renderFiles(response.files);
            } else {
              // Hi·ªÉn th·ªã tr·∫°ng th√°i tr·ªëng n·∫øu kh√¥ng c√≥ file n√†o
              emptyState.style.display = 'block';
              fileGrid.style.display = 'none';
            }
          })
          .catch(error => {
            console.error('Error fetching files:', error);
            loadingElement.style.display = 'none';
            emptyState.style.display = 'block';
            
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            Utils.showNotification('Kh√¥ng th·ªÉ t·∫£i danh s√°ch file. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
          });
      }
      
      // Render files in the grid
      function renderFiles(files) {
        if (files.length === 0) {
          emptyState.style.display = 'block';
          fileGrid.style.display = 'none';
          return;
        }
        
        emptyState.style.display = 'none';
        fileGrid.style.display = 'grid';
        fileGrid.innerHTML = '';
        
        // S·∫Øp x·∫øp file theo t√™n n·∫øu c·∫ßn
        files.sort((a, b) => a.name.localeCompare(b.name));
        
        files.forEach(file => {
          const fileCard = createFileCard(file);
          fileGrid.appendChild(fileCard);
        });
        
        // C·∫≠p nh·∫≠t th√¥ng tin s·ªë l∆∞·ª£ng file
        const fileCount = document.createElement('div');
        fileCount.className = 'file-count';
        fileCount.innerHTML = `Hi·ªÉn th·ªã ${files.length} file`;
        fileCount.style.marginTop = '10px';
        fileCount.style.fontSize = '0.9em';
        fileCount.style.color = '#666';
        
        if (fileGrid.children.length > 0) {
          fileGrid.parentNode.insertBefore(fileCount, fileGrid);
        }
      }
      
      // Create a file card element
      function createFileCard(file) {
        const fileCard = document.createElement('div');
        fileCard.className = 'file-card';
        
        // Determine icon based on file type
        const fileIcon = Utils.getFileIcon(file.mimeType);
        
        // Format file size
        const formattedSize = Utils.formatFileSize(file.size);
        
        // C·∫Øt t√™n file n·∫øu qu√° d√†i
        const displayName = Utils.truncateText(file.name, 25);
        
        fileCard.innerHTML = `
          <div class="file-icon">${fileIcon}</div>
          <div class="file-name" title="${file.name}">${displayName}</div>
          <div class="file-size">${formattedSize}</div>
          <div class="file-actions">
            <div class="file-action download-btn" title="T·∫£i xu·ªëng">‚¨áÔ∏è</div>
            <div class="file-action share-btn" title="Chia s·∫ª">üîó</div>
            ${fileType === 'trash' 
              ? '<div class="file-action restore-btn" title="Kh√¥i ph·ª•c">‚ôªÔ∏è</div>' 
              : '<div class="file-action delete-btn" title="X√≥a">üóëÔ∏è</div>'}
          </div>
        `;
        
        // Add event listeners for file actions
        const downloadBtn = fileCard.querySelector('.download-btn');
        const shareBtn = fileCard.querySelector('.share-btn');
        
        downloadBtn.addEventListener('click', () => downloadFile(file._id));
        shareBtn.addEventListener('click', () => shareFile(file._id));
        
        if (fileType === 'trash') {
          const restoreBtn = fileCard.querySelector('.restore-btn');
          restoreBtn.addEventListener('click', () => restoreFile(file._id));
        } else {
          const deleteBtn = fileCard.querySelector('.delete-btn');
          deleteBtn.addEventListener('click', () => deleteFile(file._id));
        }
        
        // Click v√†o file card ƒë·ªÉ xem chi ti·∫øt
        fileCard.addEventListener('click', function(e) {
          // Ch·ªâ x·ª≠ l√Ω khi click v√†o card, kh√¥ng ph·∫£i c√°c n√∫t h√†nh ƒë·ªông
          if (!e.target.closest('.file-action')) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // T·∫°o n·ªôi dung chi ti·∫øt file
            modalContent.innerHTML = `
              <div class="modal-header">
                <h3>Chi ti·∫øt file</h3>
                <span class="close">&times;</span>
              </div>
              <div class="file-details">
                <div style="text-align: center; margin-bottom: 20px;">
                  <div style="font-size: 64px;">${fileIcon}</div>
                </div>
                <p><strong>T√™n file:</strong> ${file.name}</p>
                <p><strong>K√≠ch th∆∞·ªõc:</strong> ${formattedSize}</p>
                <p><strong>Lo·∫°i file:</strong> ${file.mimeType || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                <p><strong>Ng√†y t·∫°o:</strong> ${new Date(file.createdAt).toLocaleString('vi-VN')}</p>
                ${file.updatedAt ? `<p><strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong> ${new Date(file.updatedAt).toLocaleString('vi-VN')}</p>` : ''}
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn btn-primary" id="detail-download-btn">T·∫£i xu·ªëng</button>
                <button class="btn btn-primary" id="detail-share-btn">Chia s·∫ª</button>
                ${fileType === 'trash' 
                  ? '<button class="btn btn-primary" id="detail-restore-btn">Kh√¥i ph·ª•c</button>' 
                  : '<button class="btn btn-danger" id="detail-delete-btn">X√≥a</button>'}
              </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // X·ª≠ l√Ω ƒë√≥ng modal
            const closeBtn = modal.querySelector('.close');
            closeBtn.addEventListener('click', function() {
              document.body.removeChild(modal);
            });
            
            // Click b√™n ngo√†i ƒë·ªÉ ƒë√≥ng
            window.addEventListener('click', function(e) {
              if (e.target === modal) {
                document.body.removeChild(modal);
              }
            });
            
            // X·ª≠ l√Ω c√°c n√∫t trong chi ti·∫øt file
            const detailDownloadBtn = modal.querySelector('#detail-download-btn');
            const detailShareBtn = modal.querySelector('#detail-share-btn');
            
            detailDownloadBtn.addEventListener('click', function() {
              downloadFile(file._id);
            });
            
            detailShareBtn.addEventListener('click', function() {
              shareFile(file._id);
            });
            
            if (fileType === 'trash') {
              const detailRestoreBtn = modal.querySelector('#detail-restore-btn');
              detailRestoreBtn.addEventListener('click', function() {
                restoreFile(file._id);
                document.body.removeChild(modal);
              });
            } else {
              const detailDeleteBtn = modal.querySelector('#detail-delete-btn');
              detailDeleteBtn.addEventListener('click', function() {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
                  deleteFile(file._id);
                  document.body.removeChild(modal);
                }
              });
            }
          }
        });
        
        return fileCard;
      }
      
      // Upload a file
      function uploadFile(formData) {
        // S·ª≠ d·ª•ng FileAPI ƒë√£ ƒë·ªãnh nghƒ©a trong main.js v·ªõi callback ti·∫øn tr√¨nh
        FileAPI.uploadFile(formData, (percentComplete) => {
          progressBar.style.width = `${percentComplete}%`;
        })
          .then(data => {
            // ƒê√≥ng modal upload
            closeUploadModal();
            
            // Th√¥ng b√°o th√†nh c√¥ng
            Utils.showNotification('T·∫£i l√™n file th√†nh c√¥ng!', 'success');
            
            // L√†m m·ªõi danh s√°ch file
            fetchFiles(fileType);
          })
          .catch(error => {
            console.error('Error uploading file:', error);
            
            // Hi·ªÉn th·ªã l·ªói
            uploadStatus.textContent = 'T·∫£i l√™n th·∫•t b·∫°i: ' + error.message;
            Utils.showNotification('C√≥ l·ªói x·∫£y ra khi t·∫£i l√™n file: ' + error.message, 'error');
            
            // Reset n√∫t upload
            uploadSubmit.disabled = false;
          });
      }
      
      // Download a file
      function downloadFile(fileId) {
        // G·ªçi tr·ª±c ti·∫øp API download
        FileAPI.downloadFile(fileId);
      }
      
      // Share a file
      function shareFile(fileId) {
        // M·∫∑c ƒë·ªãnh h·∫øt h·∫°n sau 24 gi·ªù
        FileAPI.shareFile(fileId, 24)
          .then(data => {
            if (data.shareLink) {
              prompt('Sao ch√©p ƒë∆∞·ªùng d·∫´n n√†y ƒë·ªÉ chia s·∫ª:', data.shareLink);
              Utils.showNotification('ƒê√£ t·∫°o link chia s·∫ª th√†nh c√¥ng!', 'success');
            } else {
              Utils.showNotification('Kh√¥ng th·ªÉ t·∫°o link chia s·∫ª', 'error');
            }
          })
          .catch(error => {
            console.error('Error sharing file:', error);
            Utils.showNotification('C√≥ l·ªói x·∫£y ra khi chia s·∫ª file', 'error');
          });
      }
      
      // Delete a file
      function deleteFile(fileId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
          return;
        }
        
        // X√≥a file (di chuy·ªÉn v√†o th√πng r√°c)
        const isPermanent = fileType === 'trash';
        
        FileAPI.deleteFile(fileId, isPermanent)
          .then(data => {
            // C·∫≠p nh·∫≠t UI b·∫±ng c√°ch lo·∫°i b·ªè file ƒë√£ x√≥a
            currentFiles = currentFiles.filter(file => file._id !== fileId);
            renderFiles(currentFiles);
            
            // Th√¥ng b√°o
            const message = isPermanent ? 'ƒê√£ x√≥a vƒ©nh vi·ªÖn file' : 'ƒê√£ chuy·ªÉn file v√†o th√πng r√°c';
            Utils.showNotification(message, 'success');
          })
          .catch(error => {
            console.error('Error deleting file:', error);
            Utils.showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a file', 'error');
          });
      }
      
      // Restore file from trash
      function restoreFile(fileId) {
        FileAPI.restoreFile(fileId)
          .then(data => {
            // C·∫≠p nh·∫≠t UI b·∫±ng c√°ch lo·∫°i b·ªè file ƒë√£ kh√¥i ph·ª•c kh·ªèi th√πng r√°c
            currentFiles = currentFiles.filter(file => file._id !== fileId);
            renderFiles(currentFiles);
            
            Utils.showNotification('ƒê√£ kh√¥i ph·ª•c file th√†nh c√¥ng', 'success');
          })
          .catch(error => {
            console.error('Error restoring file:', error);
            Utils.showNotification('C√≥ l·ªói x·∫£y ra khi kh√¥i ph·ª•c file', 'error');
          });
      }
      
      // Event listeners for settings page if it exists
      const saveSettingsBtn = document.getElementById('save-settings');
      const upgradeBtn = document.getElementById('upgrade-btn');
      const deleteAllFilesBtn = document.getElementById('delete-all-files');
      const emptyTrashBtn = document.getElementById('empty-trash');
      
      if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', function() {
          const autoDeleteDownloads = document.getElementById('auto-delete-downloads').checked;
          const notifications = document.getElementById('notifications').checked;
          
          // L∆∞u c√†i ƒë·∫∑t b·∫±ng c√°ch g·ªçi API
          UserAPI.updateSettings({
            autoDeleteDownloads,
            notificationsEnabled: notifications
          })
            .then(data => {
              Utils.showNotification('C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
            })
            .catch(error => {
              console.error('Error saving settings:', error);
              Utils.showNotification('C√≥ l·ªói x·∫£y ra khi l∆∞u c√†i ƒë·∫∑t', 'error');
            });
        });
      }
      
      if (upgradeBtn) {
        upgradeBtn.addEventListener('click', function() {
          alert('T√≠nh nƒÉng n√¢ng c·∫•p t√†i kho·∫£n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng th·ª≠ l·∫°i sau! (Gi·∫£ l·∫≠p)');
        });
      }
      
      if (deleteAllFilesBtn) {
        deleteAllFilesBtn.addEventListener('click', function() {
          if (confirm('C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn T·∫§T C·∫¢ file c·ªßa b·∫°n. Ti·∫øp t·ª•c?')) {
            alert('ƒê√£ g·ª≠i y√™u c·∫ßu x√≥a t·∫•t c·∫£ file. Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t... (Gi·∫£ l·∫≠p)');
          }
        });
      }
      
      if (emptyTrashBtn) {
        emptyTrashBtn.addEventListener('click', function() {
          if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën d·ªçn s·∫°ch th√πng r√°c? T·∫•t c·∫£ file s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.')) {
            // G·ªçi API ƒë·ªÉ d·ªçn th√πng r√°c
            fetch('/api/files/empty-trash', {
              method: 'POST'
            })
              .then(response => response.json())
              .then(data => {
                Utils.showNotification('ƒê√£ d·ªçn s·∫°ch th√πng r√°c', 'success');
                // C·∫≠p nh·∫≠t UI
                currentFiles = [];
                emptyState.style.display = 'block';
                fileGrid.style.display = 'none';
              })
              .catch(error => {
                console.error('Error emptying trash:', error);
                Utils.showNotification('C√≥ l·ªói x·∫£y ra khi d·ªçn th√πng r√°c', 'error');
              });
          }
        });
      }
    });
  </script>
</body>
</html> 