<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng - TeleDrive Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .admin-page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .admin-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h1 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .users-table {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .table tr:hover {
            background: #f8f9fa;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-details {
            display: flex;
            flex-direction: column;
        }
        .user-name {
            font-weight: bold;
            color: #333;
        }
        .user-phone {
            font-size: 12px;
            color: #666;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-admin {
            background: #dc3545;
            color: white;
        }
        .status-user {
            background: #28a745;
            color: white;
        }
        .status-verified {
            background: #007bff;
            color: white;
        }
        .status-unverified {
            background: #6c757d;
            color: white;
        }
        .actions {
            display: flex;
            gap: 5px;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #007bff;
            text-decoration: none;
            margin-bottom: 20px;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
        }
        .close {
            font-size: 24px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="admin-page">
        <a href="{{ url_for('index') }}" class="back-link">
            <span>‚Üê</span> Quay l·∫°i Dashboard
        </a>
        
        <div class="admin-header">
            <h1>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
            <button class="btn btn-success" onclick="openAddUserModal()">
                ‚ûï Th√™m ng∆∞·ªùi d√πng
            </button>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." id="searchInput" onkeyup="searchUsers()">
            <button class="btn btn-primary" onclick="refreshUsers()">
                üîÑ L√†m m·ªõi
            </button>
        </div>

        <div class="users-table">
            <table class="table" id="usersTable">
                <thead>
                    <tr>
                        <th>Ng∆∞·ªùi d√πng</th>
                        <th>Quy·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Th√™m ng∆∞·ªùi d√πng</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId" name="user_id">
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email">
                </div>
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u:</label>
                    <input type="password" id="password" name="password">
                    <small>ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi (khi s·ª≠a)</small>
                </div>
                <div class="form-group">
                    <label for="isAdmin">Quy·ªÅn:</label>
                    <select id="isAdmin" name="is_admin">
                        <option value="false">Ng∆∞·ªùi d√πng th∆∞·ªùng</option>
                        <option value="true">Qu·∫£n tr·ªã vi√™n</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let users = [];
        let editingUserId = null;

        // Load users on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        function loadUsers() {
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        users = data.users;
                        renderUsers(users);
                    } else {
                        alert('L·ªói: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng');
                });
        }

        function renderUsers(userList) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            userList.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                            <div class="user-details">
                                <div class="user-name">${user.username}</div>
                                <div class="user-phone">${user.phone_number}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${user.is_admin ? 'status-admin' : 'status-user'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${user.is_verified ? 'status-verified' : 'status-unverified'}">
                            ${user.is_verified ? 'ƒê√£ x√°c th·ª±c' : 'Ch∆∞a x√°c th·ª±c'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString('vi-VN')}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-warning" onclick="editUser(${user.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})" ${user.is_admin ? 'disabled' : ''}>üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredUsers = users.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.phone_number.includes(searchTerm) ||
                (user.email && user.email.toLowerCase().includes(searchTerm))
            );
            renderUsers(filteredUsers);
        }

        function refreshUsers() {
            loadUsers();
        }

        function openAddUserModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Th√™m ng∆∞·ªùi d√πng';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').style.display = 'block';
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                editingUserId = userId;
                document.getElementById('modalTitle').textContent = 'S·ª≠a ng∆∞·ªùi d√πng';
                document.getElementById('userId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('phone').value = user.phone_number;
                document.getElementById('email').value = user.email || '';
                document.getElementById('isAdmin').value = user.is_admin.toString();
                document.getElementById('userModal').style.display = 'block';
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            editingUserId = null;
        }

        function deleteUser(userId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) {
                fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng');
                        loadUsers();
                    } else {
                        alert('L·ªói: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting user:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a ng∆∞·ªùi d√πng');
                });
            }
        }

        // Handle form submission
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const userData = Object.fromEntries(formData.entries());
            
            const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
            const method = editingUserId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(editingUserId ? 'C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng' : 'Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng');
                    closeUserModal();
                    loadUsers();
                } else {
                    alert('L·ªói: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving user:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u ng∆∞·ªùi d√πng');
            });
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target == modal) {
                closeUserModal();
            }
        }
    </script>
</body>
</html>
