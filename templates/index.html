{% extends "base.html" %}

{% block title %}Dashboard - TeleDrive{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="showUploadModal()">
            <span class="material-icons">upload</span>
            Upload Files
        </button>
        <button class="btn btn-secondary" onclick="showCreateFolderModal()">
            <span class="material-icons">create_new_folder</span>
            New Folder
        </button>
        <button class="btn btn-primary" onclick="location.href='{{ url_for('scan_page') }}'">
            <span class="material-icons">add</span>
            New Scan
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">folder</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-files">{{ files|length }}</div>
            <div class="stat-label">Total Files</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">cloud_download</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-scans">-</div>
            <div class="stat-label">Scans Completed</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">storage</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-size">-</div>
            <div class="stat-label">Total Size</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">schedule</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="last-scan">-</div>
            <div class="stat-label">Last Scan</div>
        </div>
    </div>
</div>

<!-- Breadcrumb Navigation -->
<div class="breadcrumb-container">
    <nav class="breadcrumb" id="breadcrumb">
        <a href="#" class="breadcrumb-item" onclick="navigateToFolder(null)">
            <span class="material-icons">home</span>
            Home
        </a>
    </nav>
</div>

<!-- Files & Folders -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Files & Folders</h2>
        <div class="section-actions">
            <button class="btn btn-small" onclick="toggleViewMode()">
                <span class="material-icons" id="view-mode-icon">view_list</span>
                <span id="view-mode-text">List View</span>
            </button>
            <button class="btn btn-secondary" onclick="refreshFiles()">
                <span class="material-icons">refresh</span>
                Refresh
            </button>
        </div>
    </div>
    
    <div class="files-container">
        {% if files %}
        <div class="files-grid" id="files-grid">
            {% for file in files %}
            <div class="file-card" data-filename="{{ file.name }}">
                <div class="file-icon">
                    {% if file.name.endswith('.json') %}
                    <span class="material-icons">code</span>
                    {% elif file.name.endswith('.csv') %}
                    <span class="material-icons">table_chart</span>
                    {% elif file.name.endswith('.xlsx') %}
                    <span class="material-icons">description</span>
                    {% else %}
                    <span class="material-icons">insert_drive_file</span>
                    {% endif %}
                </div>
                
                <div class="file-info">
                    <div class="file-name">{{ file.name }}</div>
                    <div class="file-details">
                        <span class="file-size">{{ (file.size / 1024) | round(1) }} KB</span>
                        <span class="file-date">{{ file.modified }}</span>
                    </div>
                </div>
                
                <div class="file-actions">
                    <button class="file-action-btn" onclick="downloadFile('{{ file.name }}')">
                        <span class="material-icons">download</span>
                    </button>
                    <button class="file-action-btn" onclick="showFileMenu(event, '{{ file.name }}')">
                        <span class="material-icons">more_vert</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <span class="material-icons">folder_open</span>
            </div>
            <div class="empty-title">No files yet</div>
            <div class="empty-description">Start by scanning a Telegram channel to see files here</div>
            <button class="btn btn-primary" onclick="location.href='{{ url_for('scan_page') }}'">
                <span class="material-icons">scanner</span>
                Start Scanning
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- File Context Menu -->
<div id="file-menu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="downloadFile(currentFile)">
        <span class="material-icons">download</span>
        Download
    </div>
    <div class="context-menu-item" onclick="previewFile(currentFile)">
        <span class="material-icons">visibility</span>
        Preview
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="deleteFile(currentFile)">
        <span class="material-icons">delete</span>
        Delete
    </div>
</div>

<!-- Create Folder Modal -->
<div id="create-folder-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Folder</h3>
            <button class="modal-close" onclick="hideCreateFolderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="create-folder-form" onsubmit="createFolder(event)">
                <div class="form-group">
                    <label class="form-label" for="folder-name">Folder Name</label>
                    <input type="text" id="folder-name" class="form-input" placeholder="Enter folder name" required maxlength="255">
                    <div class="form-help">Folder name cannot contain / or \ characters</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="parent-folder">Parent Folder</label>
                    <select id="parent-folder" class="form-input">
                        <option value="">Root</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideCreateFolderModal()">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('create-folder-form').requestSubmit()">Create Folder</button>
        </div>
    </div>
</div>

<!-- Upload Files Modal -->
<div id="upload-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Files</h3>
            <button class="modal-close" onclick="hideUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <span class="material-icons">cloud_upload</span>
                </div>
                <p class="upload-text">Drag and drop files here or click to select</p>
                <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileSelect(event)">
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                    Select Files
                </button>
            </div>
            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-progress-fill"></div>
                </div>
                <p class="progress-text" id="upload-progress-text">Uploading...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideUploadModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFile = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    setupFileGrid();
});

// Load dashboard statistics
function loadStats() {
    fetch('/api/get_files')
        .then(response => response.json())
        .then(files => {
            document.getElementById('total-files').textContent = files.length;
            
            let totalSize = files.reduce((sum, file) => sum + file.size, 0);
            document.getElementById('total-size').textContent = formatFileSize(totalSize);
            
            if (files.length > 0) {
                document.getElementById('last-scan').textContent = files[0].modified;
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// Refresh files list
function refreshFiles() {
    location.reload();
}

// Folder management functions
function showCreateFolderModal() {
    loadFolderOptions();
    document.getElementById('create-folder-modal').style.display = 'flex';
    document.getElementById('folder-name').focus();
}

function hideCreateFolderModal() {
    document.getElementById('create-folder-modal').style.display = 'none';
    document.getElementById('create-folder-form').reset();
}

function loadFolderOptions() {
    fetch('/api/folders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('parent-folder');
                select.innerHTML = '<option value="">Root</option>';

                function addFolderOptions(folders, prefix = '') {
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = prefix + folder.name;
                        select.appendChild(option);

                        if (folder.children && folder.children.length > 0) {
                            addFolderOptions(folder.children, prefix + folder.name + '/');
                        }
                    });
                }

                addFolderOptions(data.folders);
            }
        })
        .catch(error => {
            console.error('Error loading folders:', error);
        });
}

function createFolder(event) {
    event.preventDefault();

    const folderName = document.getElementById('folder-name').value.trim();
    const parentId = document.getElementById('parent-folder').value || null;

    if (!folderName) {
        showToast('Please enter a folder name', 'error');
        return;
    }

    const data = {
        name: folderName,
        parent_id: parentId
    };

    fetch('/api/folders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            hideCreateFolderModal();
            refreshFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error creating folder: ' + error.message, 'error');
    });
}

// Navigation functions
let currentFolder = null;
let viewMode = 'grid'; // 'grid' or 'list'

function navigateToFolder(folderId, folderName = null) {
    currentFolder = folderId;

    // Update breadcrumb
    updateBreadcrumb(folderId, folderName);

    // Load files for this folder
    loadFolderContents(folderId);
}

function updateBreadcrumb(folderId, folderName) {
    const breadcrumb = document.getElementById('breadcrumb');

    if (!folderId) {
        // Root folder
        breadcrumb.innerHTML = `
            <a href="#" class="breadcrumb-item active" onclick="navigateToFolder(null)">
                <span class="material-icons">home</span>
                Home
            </a>
        `;
    } else {
        // Add folder to breadcrumb (simplified - in real app would build full path)
        breadcrumb.innerHTML = `
            <a href="#" class="breadcrumb-item" onclick="navigateToFolder(null)">
                <span class="material-icons">home</span>
                Home
            </a>
            <span class="breadcrumb-separator">â€º</span>
            <a href="#" class="breadcrumb-item active" onclick="navigateToFolder(${folderId}, '${folderName}')">
                <span class="material-icons">folder</span>
                ${folderName}
            </a>
        `;
    }
}

function loadFolderContents(folderId) {
    // This would load files and folders for the specified folder
    // For now, just refresh the current view
    refreshFiles();
}

function toggleViewMode() {
    const filesGrid = document.getElementById('files-grid');
    const viewModeIcon = document.getElementById('view-mode-icon');
    const viewModeText = document.getElementById('view-mode-text');

    if (viewMode === 'grid') {
        viewMode = 'list';
        filesGrid.classList.remove('files-grid');
        filesGrid.classList.add('files-list');
        viewModeIcon.textContent = 'view_module';
        viewModeText.textContent = 'Grid View';
    } else {
        viewMode = 'grid';
        filesGrid.classList.remove('files-list');
        filesGrid.classList.add('files-grid');
        viewModeIcon.textContent = 'view_list';
        viewModeText.textContent = 'List View';
    }
}

// Upload modal functions
function showUploadModal() {
    document.getElementById('upload-modal').style.display = 'flex';
    setupUploadArea();
}

function hideUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    resetUploadArea();
}

function setupUploadArea() {
    const uploadArea = document.getElementById('upload-area');

    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            uploadFilesFromModal(files);
        }
    });
}

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    if (files.length > 0) {
        uploadFilesFromModal(files);
    }
}

function uploadFilesFromModal(files) {
    const formData = new FormData();

    // Add files to form data
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }

    // Add current folder if available
    if (window.currentFolder) {
        formData.append('folder_id', window.currentFolder);
    }

    // Show progress
    showUploadProgress();

    // Upload files
    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideUploadProgress();
        if (data.success) {
            showToast(data.message, 'success');
            hideUploadModal();
            refreshFiles();
        } else {
            showToast('Upload failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideUploadProgress();
        showToast('Upload error: ' + error.message, 'error');
    });
}

function showUploadProgress() {
    document.getElementById('upload-area').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'block';
}

function hideUploadProgress() {
    document.getElementById('upload-area').style.display = 'block';
    document.getElementById('upload-progress').style.display = 'none';
}

function resetUploadArea() {
    document.getElementById('file-input').value = '';
    hideUploadProgress();
}

// Setup file grid interactions
function setupFileGrid() {
    // Add click handlers for file cards
    document.querySelectorAll('.file-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (!e.target.closest('.file-actions')) {
                const filename = this.dataset.filename;
                previewFile(filename);
            }
        });
    });
}

// Show file context menu
function showFileMenu(event, filename) {
    event.stopPropagation();
    currentFile = filename;
    
    const menu = document.getElementById('file-menu');
    menu.style.display = 'block';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    
    // Hide menu when clicking elsewhere
    document.addEventListener('click', hideFileMenu);
}

// Hide file context menu
function hideFileMenu() {
    document.getElementById('file-menu').style.display = 'none';
    document.removeEventListener('click', hideFileMenu);
}

// Download file
function downloadFile(filename) {
    const link = document.createElement('a');
    link.href = '/output/' + filename;
    link.download = filename;
    link.click();
    hideFileMenu();
}

// Preview file
function previewFile(filename) {
    // Use the global TeleDrive function
    if (window.TeleDrive && window.TeleDrive.previewFile) {
        window.TeleDrive.previewFile(filename);
    } else {
        showToast('File preview functionality loading...', 'info');
    }
    hideFileMenu();
}

// Delete file
function deleteFile(filename) {
    if (confirm('Are you sure you want to delete this file?')) {
        // Use the global TeleDrive function
        if (window.TeleDrive && window.TeleDrive.deleteFile) {
            window.TeleDrive.deleteFile(filename);
        } else {
            showToast('File deletion functionality loading...', 'info');
        }
    }
    hideFileMenu();
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}
</script>
{% endblock %}
