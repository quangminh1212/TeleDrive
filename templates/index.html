{% extends "base.html" %}

{% block title %}Dashboard - TeleDrive{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="showUploadModal()">
            <span class="material-icons">upload</span>
            Upload Files
        </button>
        <button class="btn btn-secondary" onclick="showCreateFolderModal()">
            <span class="material-icons">create_new_folder</span>
            New Folder
        </button>
        <button class="btn btn-primary" onclick="location.href='{{ url_for('scan_page') }}'">
            <span class="material-icons">add</span>
            New Scan
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">folder</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-files">{{ files|length }}</div>
            <div class="stat-label">Total Files</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">cloud_download</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-scans">-</div>
            <div class="stat-label">Scans Completed</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">storage</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-size">-</div>
            <div class="stat-label">Total Size</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">schedule</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="last-scan">-</div>
            <div class="stat-label">Last Scan</div>
        </div>
    </div>
</div>

<!-- Breadcrumb Navigation -->
<div class="breadcrumb-container">
    <nav class="breadcrumb" id="breadcrumb">
        <a href="#" class="breadcrumb-item" onclick="navigateToFolder(null)">
            <span class="material-icons">home</span>
            Home
        </a>
    </nav>
</div>

<!-- Files & Folders -->
<div class="section">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-container">
        <nav class="breadcrumb">
            <a href="#" class="breadcrumb-item" onclick="navigateToFolder(null)">
                <span class="material-icons">home</span>
                Home
            </a>
            <div id="breadcrumb-path"></div>
        </nav>
    </div>

    <div class="section-header">
        <h2 class="section-title">Files & Folders</h2>
        <div class="section-actions">
            <button class="btn btn-small" onclick="toggleSelectMode()" id="select-mode-btn">
                <span class="material-icons">check_box_outline_blank</span>
                <span id="select-mode-text">Select</span>
            </button>
            <button class="btn btn-small" onclick="toggleViewMode()">
                <span class="material-icons" id="view-mode-icon">view_list</span>
                <span id="view-mode-text">List View</span>
            </button>
            <button class="btn btn-secondary" onclick="refreshFiles()">
                <span class="material-icons">refresh</span>
                Refresh
            </button>
        </div>
    </div>

    <!-- Bulk Operations Toolbar -->
    <div class="bulk-toolbar" id="bulk-toolbar" style="display: none;">
        <div class="bulk-info">
            <span id="selected-count">0</span> files selected
        </div>
        <div class="bulk-actions">
            <button class="btn btn-small" onclick="selectAllFiles()">
                <span class="material-icons">select_all</span>
                Select All
            </button>
            <button class="btn btn-small" onclick="deselectAllFiles()">
                <span class="material-icons">deselect</span>
                Deselect All
            </button>
            <button class="btn btn-small" onclick="showBulkMoveModal()">
                <span class="material-icons">drive_file_move</span>
                Move
            </button>
            <button class="btn btn-small" onclick="showBulkTagModal()">
                <span class="material-icons">label</span>
                Tag
            </button>
            <button class="btn btn-danger" onclick="bulkDeleteFiles()">
                <span class="material-icons">delete</span>
                Delete
            </button>
        </div>
    </div>
    
    <div class="files-container">
        {% if files %}
        <div class="files-grid" id="files-grid">
            {% for file in files %}
            <div class="file-card" data-filename="{{ file.name }}" data-file-id="{{ file.id if file.id else '' }}" onclick="handleFileCardClick(event, this)">
                <div class="file-checkbox" style="display: none;">
                    <input type="checkbox" class="file-select-checkbox" onchange="handleFileSelection(this)">
                </div>

                <div class="file-icon">
                    {% if file.name.endswith('.json') %}
                    <span class="material-icons">code</span>
                    {% elif file.name.endswith('.csv') %}
                    <span class="material-icons">table_chart</span>
                    {% elif file.name.endswith('.xlsx') %}
                    <span class="material-icons">description</span>
                    {% else %}
                    <span class="material-icons">insert_drive_file</span>
                    {% endif %}
                </div>

                <div class="file-info">
                    <div class="file-name">{{ file.name }}</div>
                    <div class="file-details">
                        <span class="file-size">{{ (file.size / 1024) | round(1) }} KB</span>
                        <span class="file-date">{{ file.modified }}</span>
                    </div>
                </div>

                <div class="file-actions">
                    <button class="file-action-btn" onclick="downloadFile('{{ file.name }}')">
                        <span class="material-icons">download</span>
                    </button>
                    <button class="file-action-btn" onclick="showFileMenu(event, '{{ file.name }}')">
                        <span class="material-icons">more_vert</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <span class="material-icons">folder_open</span>
            </div>
            <div class="empty-title">No files yet</div>
            <div class="empty-description">Start by scanning a Telegram channel to see files here</div>
            <button class="btn btn-primary" onclick="location.href='{{ url_for('scan_page') }}'">
                <span class="material-icons">scanner</span>
                Start Scanning
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- File Context Menu -->
<div id="file-menu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="downloadFile(currentFile)">
        <span class="material-icons">download</span>
        Download
    </div>
    <div class="context-menu-item" onclick="previewFile(currentFile)">
        <span class="material-icons">visibility</span>
        Preview
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="showRenameModal(currentFile)">
        <span class="material-icons">edit</span>
        Rename
    </div>
    <div class="context-menu-item" onclick="showMoveModal(currentFile)">
        <span class="material-icons">drive_file_move</span>
        Move to Folder
    </div>
    <div class="context-menu-item" onclick="showTagModal(currentFile)">
        <span class="material-icons">label</span>
        Add Tags
    </div>
    <div class="context-menu-item" onclick="showShareModal(currentFile)">
        <span class="material-icons">share</span>
        Share File
    </div>
    <div class="context-menu-item" onclick="copyFileLink(currentFile)">
        <span class="material-icons">link</span>
        Copy Link
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="deleteFile(currentFile)">
        <span class="material-icons">delete</span>
        Delete
    </div>
</div>

<!-- Folder Context Menu -->
<div id="folder-menu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="openFolder(currentFolder)">
        <span class="material-icons">folder_open</span>
        Open
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="showRenameFolderModal(currentFolder)">
        <span class="material-icons">edit</span>
        Rename
    </div>
    <div class="context-menu-item danger" onclick="deleteFolder(currentFolder)">
        <span class="material-icons">delete</span>
        Delete
    </div>
</div>

<!-- Create Folder Modal -->
<div id="create-folder-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Folder</h3>
            <button class="modal-close" onclick="hideCreateFolderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="create-folder-form" onsubmit="createFolder(event)">
                <div class="form-group">
                    <label class="form-label" for="folder-name">Folder Name</label>
                    <input type="text" id="folder-name" class="form-input" placeholder="Enter folder name" required maxlength="255">
                    <div class="form-help">Folder name cannot contain / or \ characters</div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="parent-folder">Parent Folder</label>
                    <select id="parent-folder" class="form-input">
                        <option value="">Root</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideCreateFolderModal()">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('create-folder-form').requestSubmit()">Create Folder</button>
        </div>
    </div>
</div>

<!-- Upload Files Modal -->
<div id="upload-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Files</h3>
            <button class="modal-close" onclick="hideUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <span class="material-icons">cloud_upload</span>
                </div>
                <p class="upload-text">Drag and drop files here or click to select</p>
                <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileSelect(event)">
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                    Select Files
                </button>
            </div>
            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-progress-fill"></div>
                </div>
                <p class="progress-text" id="upload-progress-text">Uploading...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideUploadModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Bulk Move Modal -->
<div class="modal" id="bulk-move-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Move Selected Files</h3>
            <button class="modal-close" onclick="hideBulkMoveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="target-folder">Select Destination Folder:</label>
                <select id="target-folder" class="form-input">
                    <option value="">Root Folder</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideBulkMoveModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeBulkMove()">Move Files</button>
        </div>
    </div>
</div>

<!-- Bulk Tag Modal -->
<div class="modal" id="bulk-tag-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tag Selected Files</h3>
            <button class="modal-close" onclick="hideBulkTagModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="bulk-tags">Tags (comma-separated):</label>
                <input type="text" id="bulk-tags" class="form-input" placeholder="tag1, tag2, tag3">
                <div class="form-help">Enter tags separated by commas</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideBulkTagModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeBulkTag()">Apply Tags</button>
        </div>
    </div>
</div>

<!-- Rename File Modal -->
<div class="modal" id="rename-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rename File</h3>
            <button class="modal-close" onclick="hideRenameModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-filename">New Name:</label>
                <input type="text" id="new-filename" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideRenameModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeRename()">Rename</button>
        </div>
    </div>
</div>

<!-- Move File Modal -->
<div class="modal" id="move-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Move File</h3>
            <button class="modal-close" onclick="hideMoveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="move-target-folder">Select Destination Folder:</label>
                <select id="move-target-folder" class="form-input">
                    <option value="">Root Folder</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideMoveModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeMove()">Move</button>
        </div>
    </div>
</div>

<!-- Tag File Modal -->
<div class="modal" id="tag-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Tags</h3>
            <button class="modal-close" onclick="hideTagModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="file-tags">Tags (comma-separated):</label>
                <input type="text" id="file-tags" class="form-input" placeholder="tag1, tag2, tag3">
                <div class="form-help">Enter tags separated by commas</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideTagModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeTag()">Apply Tags</button>
        </div>
    </div>
</div>

<!-- Share File Modal -->
<div class="modal" id="share-modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Share File</h3>
            <button class="modal-close" onclick="hideShareModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="share-tabs">
                <button class="tab-btn active" onclick="switchShareTab('create')">Create Link</button>
                <button class="tab-btn" onclick="switchShareTab('manage')">Manage Links</button>
            </div>

            <!-- Create Share Tab -->
            <div class="tab-content" id="create-tab">
                <form id="share-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="share-name">Link Name (Optional)</label>
                            <input type="text" id="share-name" class="form-input" placeholder="My shared file">
                        </div>
                        <div class="form-group">
                            <label for="share-description">Description (Optional)</label>
                            <textarea id="share-description" class="form-input" rows="2" placeholder="Description of the shared file"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="share-password">Password Protection (Optional)</label>
                            <input type="password" id="share-password" class="form-input" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label for="share-expires">Expires In</label>
                            <select id="share-expires" class="form-input">
                                <option value="">Never</option>
                                <option value="1">1 Day</option>
                                <option value="7">1 Week</option>
                                <option value="30">1 Month</option>
                                <option value="90">3 Months</option>
                                <option value="365">1 Year</option>
                            </select>
                        </div>
                    </div>

                    <div class="permissions-section">
                        <h4>Permissions</h4>
                        <div class="permission-grid">
                            <label class="permission-item">
                                <input type="checkbox" id="can-view" checked>
                                <span class="checkmark"></span>
                                <div class="permission-info">
                                    <span class="permission-title">View</span>
                                    <span class="permission-desc">Allow viewing the file</span>
                                </div>
                            </label>
                            <label class="permission-item">
                                <input type="checkbox" id="can-download" checked>
                                <span class="checkmark"></span>
                                <div class="permission-info">
                                    <span class="permission-title">Download</span>
                                    <span class="permission-desc">Allow downloading the file</span>
                                </div>
                            </label>
                            <label class="permission-item">
                                <input type="checkbox" id="can-preview" checked>
                                <span class="checkmark"></span>
                                <div class="permission-info">
                                    <span class="permission-title">Preview</span>
                                    <span class="permission-desc">Allow previewing file content</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="limits-section">
                        <h4>Access Limits (Optional)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="max-downloads">Max Downloads</label>
                                <input type="number" id="max-downloads" class="form-input" placeholder="Unlimited" min="1">
                            </div>
                            <div class="form-group">
                                <label for="max-views">Max Views</label>
                                <input type="number" id="max-views" class="form-input" placeholder="Unlimited" min="1">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Manage Links Tab -->
            <div class="tab-content" id="manage-tab" style="display: none;">
                <div class="share-links-list" id="share-links-list">
                    <div class="loading-placeholder">Loading existing shares...</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="share-result" id="share-result" style="display: none;">
                <div class="share-url-container">
                    <input type="text" id="share-url" class="share-url-input" readonly>
                    <button class="btn btn-secondary" onclick="copyShareUrl()">
                        <span class="material-icons">content_copy</span>
                        Copy
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideShareModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createShareLink()" id="create-share-btn">Create Share Link</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFile = null;
let selectMode = false;
let selectedFiles = new Set();

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    setupFileGrid();
    loadFolders();
});

// Load dashboard statistics
function loadStats() {
    fetch('/api/get_files')
        .then(response => response.json())
        .then(files => {
            document.getElementById('total-files').textContent = files.length;
            
            let totalSize = files.reduce((sum, file) => sum + file.size, 0);
            document.getElementById('total-size').textContent = formatFileSize(totalSize);
            
            if (files.length > 0) {
                document.getElementById('last-scan').textContent = files[0].modified;
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// Refresh files list
function refreshFiles() {
    location.reload();
}

// Folder management functions
function showCreateFolderModal() {
    loadFolderOptions();
    document.getElementById('create-folder-modal').style.display = 'flex';
    document.getElementById('folder-name').focus();
}

function hideCreateFolderModal() {
    document.getElementById('create-folder-modal').style.display = 'none';
    document.getElementById('create-folder-form').reset();
}

function loadFolderOptions() {
    fetch('/api/folders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('parent-folder');
                select.innerHTML = '<option value="">Root</option>';

                function addFolderOptions(folders, prefix = '') {
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = prefix + folder.name;
                        select.appendChild(option);

                        if (folder.children && folder.children.length > 0) {
                            addFolderOptions(folder.children, prefix + folder.name + '/');
                        }
                    });
                }

                addFolderOptions(data.folders);
            }
        })
        .catch(error => {
            console.error('Error loading folders:', error);
        });
}

function createFolder(event) {
    event.preventDefault();

    const folderName = document.getElementById('folder-name').value.trim();
    const parentId = document.getElementById('parent-folder').value || null;

    if (!folderName) {
        showToast('Please enter a folder name', 'error');
        return;
    }

    const data = {
        name: folderName,
        parent_id: parentId
    };

    fetch('/api/folders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            hideCreateFolderModal();
            refreshFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error creating folder: ' + error.message, 'error');
    });
}

// Navigation functions
let currentFolder = null;
let viewMode = 'grid'; // 'grid' or 'list'

function navigateToFolder(folderId, folderName = null) {
    currentFolder = folderId;

    // Update breadcrumb
    updateBreadcrumb(folderId, folderName);

    // Load files for this folder
    loadFolderContents(folderId);
}

function updateBreadcrumb(folderId, folderName) {
    const breadcrumb = document.getElementById('breadcrumb');

    if (!folderId) {
        // Root folder
        breadcrumb.innerHTML = `
            <a href="#" class="breadcrumb-item active" onclick="navigateToFolder(null)">
                <span class="material-icons">home</span>
                Home
            </a>
        `;
    } else {
        // Add folder to breadcrumb (simplified - in real app would build full path)
        breadcrumb.innerHTML = `
            <a href="#" class="breadcrumb-item" onclick="navigateToFolder(null)">
                <span class="material-icons">home</span>
                Home
            </a>
            <span class="breadcrumb-separator">›</span>
            <a href="#" class="breadcrumb-item active" onclick="navigateToFolder(${folderId}, '${folderName}')">
                <span class="material-icons">folder</span>
                ${folderName}
            </a>
        `;
    }
}

function loadFolderContents(folderId) {
    // This would load files and folders for the specified folder
    // For now, just refresh the current view
    refreshFiles();
}

function toggleViewMode() {
    const filesGrid = document.getElementById('files-grid');
    const viewModeIcon = document.getElementById('view-mode-icon');
    const viewModeText = document.getElementById('view-mode-text');

    if (viewMode === 'grid') {
        viewMode = 'list';
        filesGrid.classList.remove('files-grid');
        filesGrid.classList.add('files-list');
        viewModeIcon.textContent = 'view_module';
        viewModeText.textContent = 'Grid View';
    } else {
        viewMode = 'grid';
        filesGrid.classList.remove('files-list');
        filesGrid.classList.add('files-grid');
        viewModeIcon.textContent = 'view_list';
        viewModeText.textContent = 'List View';
    }
}

// Upload modal functions
function showUploadModal() {
    document.getElementById('upload-modal').style.display = 'flex';
    setupUploadArea();
}

function hideUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    resetUploadArea();
}

function setupUploadArea() {
    const uploadArea = document.getElementById('upload-area');

    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            uploadFilesFromModal(files);
        }
    });
}

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    if (files.length > 0) {
        uploadFilesFromModal(files);
    }
}

function uploadFilesFromModal(files) {
    const formData = new FormData();

    // Add files to form data
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }

    // Add current folder if available
    if (window.currentFolder) {
        formData.append('folder_id', window.currentFolder);
    }

    // Show progress
    showUploadProgress();

    // Upload files
    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideUploadProgress();
        if (data.success) {
            showToast(data.message, 'success');
            hideUploadModal();
            refreshFiles();
        } else {
            showToast('Upload failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideUploadProgress();
        showToast('Upload error: ' + error.message, 'error');
    });
}

function showUploadProgress() {
    document.getElementById('upload-area').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'block';
}

function hideUploadProgress() {
    document.getElementById('upload-area').style.display = 'block';
    document.getElementById('upload-progress').style.display = 'none';
}

function resetUploadArea() {
    document.getElementById('file-input').value = '';
    hideUploadProgress();
}

// Setup file grid interactions
function setupFileGrid() {
    // Add click handlers for file cards
    document.querySelectorAll('.file-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (!e.target.closest('.file-actions')) {
                const filename = this.dataset.filename;
                previewFile(filename);
            }
        });
    });
}

// Show file context menu
function showFileMenu(event, filename) {
    event.stopPropagation();
    currentFile = filename;
    
    const menu = document.getElementById('file-menu');
    menu.style.display = 'block';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    
    // Hide menu when clicking elsewhere
    document.addEventListener('click', hideFileMenu);
}

// Hide file context menu
function hideFileMenu() {
    document.getElementById('file-menu').style.display = 'none';
    document.removeEventListener('click', hideFileMenu);
}

// Download file
function downloadFile(filename) {
    const link = document.createElement('a');
    link.href = '/output/' + filename;
    link.download = filename;
    link.click();
    hideFileMenu();
}

// Preview file
function previewFile(filename) {
    // Use the global TeleDrive function
    if (window.TeleDrive && window.TeleDrive.previewFile) {
        window.TeleDrive.previewFile(filename);
    } else {
        showToast('File preview functionality loading...', 'info');
    }
    hideFileMenu();
}

// Delete file
function deleteFile(filename) {
    if (confirm('Are you sure you want to delete this file?')) {
        // Use the global TeleDrive function
        if (window.TeleDrive && window.TeleDrive.deleteFile) {
            window.TeleDrive.deleteFile(filename);
        } else {
            showToast('File deletion functionality loading...', 'info');
        }
    }
    hideFileMenu();
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Multi-select and bulk operations
function toggleSelectMode() {
    selectMode = !selectMode;
    const btn = document.getElementById('select-mode-btn');
    const icon = btn.querySelector('.material-icons');
    const text = document.getElementById('select-mode-text');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    const toolbar = document.getElementById('bulk-toolbar');

    if (selectMode) {
        icon.textContent = 'check_box';
        text.textContent = 'Cancel';
        btn.classList.add('active');
        checkboxes.forEach(cb => cb.style.display = 'flex');
        toolbar.style.display = 'flex';
    } else {
        icon.textContent = 'check_box_outline_blank';
        text.textContent = 'Select';
        btn.classList.remove('active');
        checkboxes.forEach(cb => cb.style.display = 'none');
        toolbar.style.display = 'none';
        deselectAllFiles();
    }
}

function handleFileCardClick(event, card) {
    if (selectMode) {
        event.preventDefault();
        const checkbox = card.querySelector('.file-select-checkbox');
        checkbox.checked = !checkbox.checked;
        handleFileSelection(checkbox);
    } else if (!event.target.closest('.file-actions')) {
        const filename = card.dataset.filename;
        previewFile(filename);
    }
}

function handleFileSelection(checkbox) {
    const card = checkbox.closest('.file-card');
    const fileId = card.dataset.fileId;

    if (checkbox.checked) {
        selectedFiles.add(fileId);
        card.classList.add('selected');
    } else {
        selectedFiles.delete(fileId);
        card.classList.remove('selected');
    }

    updateSelectedCount();
}

function updateSelectedCount() {
    const count = selectedFiles.size;
    document.getElementById('selected-count').textContent = count;

    // Update bulk action buttons state
    const bulkActions = document.querySelectorAll('.bulk-actions .btn');
    bulkActions.forEach(btn => {
        btn.disabled = count === 0;
    });
}

function selectAllFiles() {
    const checkboxes = document.querySelectorAll('.file-select-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        handleFileSelection(checkbox);
    });
}

function deselectAllFiles() {
    const checkboxes = document.querySelectorAll('.file-select-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        handleFileSelection(checkbox);
    });
    selectedFiles.clear();
    updateSelectedCount();
}

function showBulkMoveModal() {
    if (selectedFiles.size === 0) {
        showToast('Please select files first', 'warning');
        return;
    }
    document.getElementById('bulk-move-modal').style.display = 'flex';
}

function hideBulkMoveModal() {
    document.getElementById('bulk-move-modal').style.display = 'none';
}

function showBulkTagModal() {
    if (selectedFiles.size === 0) {
        showToast('Please select files first', 'warning');
        return;
    }
    document.getElementById('bulk-tag-modal').style.display = 'flex';
}

function hideBulkTagModal() {
    document.getElementById('bulk-tag-modal').style.display = 'none';
}

function executeBulkMove() {
    const folderId = document.getElementById('target-folder').value || null;
    const fileIds = Array.from(selectedFiles);

    fetch('/api/files/bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            operation: 'move',
            file_ids: fileIds,
            folder_id: folderId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Moved ${data.affected_files} files successfully`, 'success');
            hideBulkMoveModal();
            refreshFiles();
            deselectAllFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error moving files: ' + error.message, 'error');
    });
}

function executeBulkTag() {
    const tagsInput = document.getElementById('bulk-tags').value.trim();
    if (!tagsInput) {
        showToast('Please enter tags', 'warning');
        return;
    }

    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
    const fileIds = Array.from(selectedFiles);

    fetch('/api/files/bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            operation: 'tag',
            file_ids: fileIds,
            tags: tags
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Tagged ${data.affected_files} files successfully`, 'success');
            hideBulkTagModal();
            refreshFiles();
            deselectAllFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error tagging files: ' + error.message, 'error');
    });
}

function bulkDeleteFiles() {
    if (selectedFiles.size === 0) {
        showToast('Please select files first', 'warning');
        return;
    }

    if (!confirm(`Are you sure you want to delete ${selectedFiles.size} selected files?`)) {
        return;
    }

    const fileIds = Array.from(selectedFiles);

    fetch('/api/files/bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            operation: 'delete',
            file_ids: fileIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Deleted ${data.affected_files} files successfully`, 'success');
            refreshFiles();
            deselectAllFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error deleting files: ' + error.message, 'error');
    });
}

function loadFolders() {
    fetch('/api/folders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('target-folder');
                select.innerHTML = '<option value="">Root Folder</option>';

                function addFolderOptions(folders, prefix = '') {
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = prefix + folder.name;
                        select.appendChild(option);

                        if (folder.children && folder.children.length > 0) {
                            addFolderOptions(folder.children, prefix + '  ');
                        }
                    });
                }

                addFolderOptions(data.folders);
            }
        })
        .catch(error => {
            console.error('Error loading folders:', error);
        });
}

// Individual file operations
let currentFileId = null;
let currentFolder = null;

function showRenameModal(filename) {
    currentFile = filename;
    document.getElementById('new-filename').value = filename;
    document.getElementById('rename-modal').style.display = 'flex';
    hideFileMenu();
}

function hideRenameModal() {
    document.getElementById('rename-modal').style.display = 'none';
}

function executeRename() {
    const newName = document.getElementById('new-filename').value.trim();
    if (!newName) {
        showToast('Please enter a new name', 'warning');
        return;
    }

    // Find file ID from filename (this is a simplified approach)
    const fileCard = document.querySelector(`[data-filename="${currentFile}"]`);
    const fileId = fileCard ? fileCard.dataset.fileId : null;

    if (!fileId) {
        showToast('File ID not found', 'error');
        return;
    }

    fetch(`/api/files/${fileId}/rename`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            hideRenameModal();
            refreshFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error renaming file: ' + error.message, 'error');
    });
}

function showMoveModal(filename) {
    currentFile = filename;
    loadFoldersForMove();
    document.getElementById('move-modal').style.display = 'flex';
    hideFileMenu();
}

function hideMoveModal() {
    document.getElementById('move-modal').style.display = 'none';
}

function executeMove() {
    const folderId = document.getElementById('move-target-folder').value || null;
    const fileCard = document.querySelector(`[data-filename="${currentFile}"]`);
    const fileId = fileCard ? fileCard.dataset.fileId : null;

    if (!fileId) {
        showToast('File ID not found', 'error');
        return;
    }

    fetch(`/api/files/${fileId}/move`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ folder_id: folderId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            hideMoveModal();
            refreshFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error moving file: ' + error.message, 'error');
    });
}

function showTagModal(filename) {
    currentFile = filename;
    document.getElementById('tag-modal').style.display = 'flex';
    hideFileMenu();
}

function hideTagModal() {
    document.getElementById('tag-modal').style.display = 'none';
}

function executeTag() {
    const tagsInput = document.getElementById('file-tags').value.trim();
    if (!tagsInput) {
        showToast('Please enter tags', 'warning');
        return;
    }

    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
    const fileCard = document.querySelector(`[data-filename="${currentFile}"]`);
    const fileId = fileCard ? fileCard.dataset.fileId : null;

    if (!fileId) {
        showToast('File ID not found', 'error');
        return;
    }

    fetch(`/api/files/${fileId}/tags`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tags: tags })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            hideTagModal();
            refreshFiles();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error tagging file: ' + error.message, 'error');
    });
}

function copyFileLink(filename) {
    const link = window.location.origin + '/download/' + encodeURIComponent(filename);
    navigator.clipboard.writeText(link).then(() => {
        showToast('File link copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy link', 'error');
    });
    hideFileMenu();
}

function loadFoldersForMove() {
    fetch('/api/folders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('move-target-folder');
                select.innerHTML = '<option value="">Root Folder</option>';

                function addFolderOptions(folders, prefix = '') {
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = prefix + folder.name;
                        select.appendChild(option);

                        if (folder.children && folder.children.length > 0) {
                            addFolderOptions(folder.children, prefix + '  ');
                        }
                    });
                }

                addFolderOptions(data.folders);
            }
        })
        .catch(error => {
            console.error('Error loading folders:', error);
        });
}

// Breadcrumb navigation
function navigateToFolder(folderId) {
    // This would filter files by folder and update breadcrumbs
    // For now, just refresh to show all files
    refreshFiles();
}

// Folder operations
function openFolder(folderId) {
    navigateToFolder(folderId);
}

function showRenameFolderModal(folderId) {
    // Implementation for folder rename
    showToast('Folder rename functionality coming soon', 'info');
}

function deleteFolder(folderId) {
    if (confirm('Are you sure you want to delete this folder?')) {
        fetch(`/api/folders/${folderId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                refreshFiles();
            } else {
                showToast(data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error deleting folder: ' + error.message, 'error');
        });
    }
}

// File sharing functions
let currentShareFile = null;

function showShareModal(filename) {
    currentShareFile = filename;
    currentFile = filename;

    // Reset form
    document.getElementById('share-form').reset();
    document.getElementById('can-view').checked = true;
    document.getElementById('can-download').checked = true;
    document.getElementById('can-preview').checked = true;

    // Switch to create tab
    switchShareTab('create');

    // Hide result section
    document.getElementById('share-result').style.display = 'none';
    document.getElementById('create-share-btn').style.display = 'inline-flex';

    // Show modal
    document.getElementById('share-modal').style.display = 'flex';

    // Load existing shares
    loadExistingShares();

    hideFileMenu();
}

function hideShareModal() {
    document.getElementById('share-modal').style.display = 'none';
    currentShareFile = null;
}

function switchShareTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Show/hide tab content
    document.getElementById('create-tab').style.display = tab === 'create' ? 'block' : 'none';
    document.getElementById('manage-tab').style.display = tab === 'manage' ? 'block' : 'none';

    // Update footer buttons
    const createBtn = document.getElementById('create-share-btn');
    createBtn.style.display = tab === 'create' ? 'inline-flex' : 'none';
}

function createShareLink() {
    if (!currentShareFile) {
        showToast('No file selected', 'error');
        return;
    }

    // Get file ID from filename (simplified approach)
    const fileCard = document.querySelector(`[data-filename="${currentShareFile}"]`);
    const fileId = fileCard ? fileCard.dataset.fileId : null;

    if (!fileId) {
        showToast('File ID not found', 'error');
        return;
    }

    // Collect form data
    const shareData = {
        name: document.getElementById('share-name').value.trim(),
        description: document.getElementById('share-description').value.trim(),
        password: document.getElementById('share-password').value,
        expires_in_days: document.getElementById('share-expires').value || null,
        can_view: document.getElementById('can-view').checked,
        can_download: document.getElementById('can-download').checked,
        can_preview: document.getElementById('can-preview').checked,
        max_downloads: document.getElementById('max-downloads').value || null,
        max_views: document.getElementById('max-views').value || null
    };

    // Convert to numbers
    if (shareData.expires_in_days) shareData.expires_in_days = parseInt(shareData.expires_in_days);
    if (shareData.max_downloads) shareData.max_downloads = parseInt(shareData.max_downloads);
    if (shareData.max_views) shareData.max_views = parseInt(shareData.max_views);

    // Create share link
    fetch(`/api/files/${fileId}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(shareData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show share URL
            document.getElementById('share-url').value = data.share_url;
            document.getElementById('share-result').style.display = 'block';
            document.getElementById('create-share-btn').style.display = 'none';

            showToast('Share link created successfully!', 'success');

            // Refresh existing shares
            loadExistingShares();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error creating share link: ' + error.message, 'error');
    });
}

function copyShareUrl() {
    const shareUrl = document.getElementById('share-url');
    shareUrl.select();
    shareUrl.setSelectionRange(0, 99999); // For mobile devices

    navigator.clipboard.writeText(shareUrl.value).then(() => {
        showToast('Share URL copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        document.execCommand('copy');
        showToast('Share URL copied to clipboard!', 'success');
    });
}

function loadExistingShares() {
    if (!currentShareFile) return;

    const fileCard = document.querySelector(`[data-filename="${currentShareFile}"]`);
    const fileId = fileCard ? fileCard.dataset.fileId : null;

    if (!fileId) return;

    fetch(`/api/files/${fileId}/shares`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayExistingShares(data.shares);
            }
        })
        .catch(error => {
            console.error('Error loading existing shares:', error);
        });
}

function displayExistingShares(shares) {
    const container = document.getElementById('share-links-list');

    if (shares.length === 0) {
        container.innerHTML = `
            <div class="no-shares">
                <span class="material-icons">share</span>
                <p>No existing shares for this file</p>
            </div>
        `;
        return;
    }

    let html = '';
    shares.forEach(share => {
        const createdDate = new Date(share.created_at).toLocaleDateString();
        const expiresDate = share.expires_at ? new Date(share.expires_at).toLocaleDateString() : 'Never';

        html += `
            <div class="share-item">
                <div class="share-info">
                    <div class="share-name">${share.name || 'Unnamed Share'}</div>
                    <div class="share-details">
                        <span>Created: ${createdDate}</span>
                        <span>Expires: ${expiresDate}</span>
                        <span>Views: ${share.view_count}</span>
                        <span>Downloads: ${share.download_count}</span>
                    </div>
                </div>
                <div class="share-actions">
                    <button class="btn btn-small" onclick="copyShareUrlFromList('${share.share_url}')">
                        <span class="material-icons">content_copy</span>
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteShareLink(${share.id})">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function copyShareUrlFromList(url) {
    navigator.clipboard.writeText(url).then(() => {
        showToast('Share URL copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy URL', 'error');
    });
}

function deleteShareLink(shareId) {
    if (!confirm('Are you sure you want to delete this share link?')) {
        return;
    }

    fetch(`/api/shares/${shareId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Share link deleted successfully', 'success');
            loadExistingShares();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error deleting share link: ' + error.message, 'error');
    });
}
</script>
{% endblock %}
