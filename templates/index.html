{% extends "base.html" %}

{% block title %}My Drive - TeleDrive{% endblock %}

{% block content %}
<div class="content-header">
    <div class="content-title">
        <h1>My Drive</h1>
    </div>
    
    <div class="content-actions">
        <div class="view-options">
            <button class="view-btn active" id="gridView" title="Grid view">
                <i class="fas fa-th"></i>
            </button>
            <button class="view-btn" id="listView" title="List view">
                <i class="fas fa-list"></i>
            </button>
        </div>
        
        <div class="sort-options">
            <select class="sort-select" id="sortSelect">
                <option value="name">Name</option>
                <option value="modified">Last modified</option>
                <option value="size">File size</option>
                <option value="type">Type</option>
            </select>
        </div>
        
        <button class="filter-btn" id="filterBtn" title="Filter">
            <i class="fas fa-filter"></i>
        </button>
    </div>
</div>

<!-- Quick Access -->
<div class="quick-access">
    <h2 class="section-title">Quick access</h2>
    <div class="quick-items">
        <div class="quick-item">
            <div class="quick-icon">
                <i class="fas fa-star"></i>
            </div>
            <span>Starred</span>
        </div>
        <div class="quick-item">
            <div class="quick-icon">
                <i class="fas fa-clock"></i>
            </div>
            <span>Recent</span>
        </div>
        <div class="quick-item">
            <div class="quick-icon">
                <i class="fab fa-telegram"></i>
            </div>
            <span>Telegram Files</span>
        </div>
        <div class="quick-item">
            <div class="quick-icon">
                <i class="fas fa-image"></i>
            </div>
            <span>Images</span>
        </div>
    </div>
</div>

<!-- Files Section -->
<div class="files-section">
    <div class="section-header">
        <h2 class="section-title">Files</h2>
        <div class="section-info">
            <span class="file-count">{{ total_files }} items</span>
        </div>
    </div>
    
    <!-- Files Grid/List Container -->
    <div class="files-container" id="filesContainer">
        {% if files %}
            <div class="files-grid" id="filesGrid">
                {% for file in files %}
                <div class="file-item" data-file-id="{{ file.id }}" data-file-type="{{ file.type }}">
                    <div class="file-preview">
                        {% if file.type == 'photo' %}
                            <div class="file-thumbnail image-thumbnail">
                                <i class="{{ file.icon }}"></i>
                            </div>
                        {% else %}
                            <div class="file-thumbnail">
                                <i class="{{ file.icon }}"></i>
                            </div>
                        {% endif %}
                        
                        <div class="file-actions">
                            <button class="file-action-btn" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="file-action-btn" title="Share">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="file-action-btn" title="More">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="file-info">
                        <div class="file-name" title="{{ file.name }}">{{ file.name }}</div>
                        <div class="file-meta">
                            <span class="file-size">{{ file.formatted_size }}</span>
                            {% if file.source == 'telegram' %}
                                <span class="file-source">
                                    <i class="fab fa-telegram"></i>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h3>No files yet</h3>
                <p>Upload files or scan Telegram channels to get started</p>
                <div class="empty-actions">
                    <button class="btn btn-primary" id="emptyUploadBtn">
                        <i class="fas fa-upload"></i>
                        Upload files
                    </button>
                    <button class="btn btn-secondary" id="emptyScanBtn">
                        <i class="fab fa-telegram"></i>
                        Scan Telegram
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- File Context Menu -->
<div class="context-menu" id="fileContextMenu">
    <div class="context-item" id="openFile">
        <i class="fas fa-eye"></i>
        <span>Open</span>
    </div>
    <div class="context-item" id="downloadFile">
        <i class="fas fa-download"></i>
        <span>Download</span>
    </div>
    <div class="context-item" id="shareFile">
        <i class="fas fa-share"></i>
        <span>Share</span>
    </div>
    <hr class="context-divider">
    <div class="context-item" id="renameFile">
        <i class="fas fa-edit"></i>
        <span>Rename</span>
    </div>
    <div class="context-item" id="moveFile">
        <i class="fas fa-arrows-alt"></i>
        <span>Move</span>
    </div>
    <hr class="context-divider">
    <div class="context-item" id="starFile">
        <i class="fas fa-star"></i>
        <span>Add to starred</span>
    </div>
    <div class="context-item danger" id="deleteFile">
        <i class="fas fa-trash"></i>
        <span>Move to trash</span>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal large" id="previewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="previewTitle">File Preview</h3>
            <div class="modal-actions">
                <button class="modal-btn" id="downloadPreview" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="modal-btn" id="sharePreview" title="Share">
                    <i class="fas fa-share"></i>
                </button>
                <button class="modal-close" id="closePreviewModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="modal-body">
            <div class="preview-container" id="previewContainer">
                <!-- Preview content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize file grid functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeFileGrid();
    initializeViewToggle();
    initializeSorting();
    initializeContextMenu();
    initializeFilePreview();
});

function initializeFileGrid() {
    const fileItems = document.querySelectorAll('.file-item');
    
    fileItems.forEach(item => {
        // Double click to open/preview
        item.addEventListener('dblclick', function() {
            const fileId = this.dataset.fileId;
            const fileType = this.dataset.fileType;
            openFilePreview(fileId, fileType);
        });
        
        // Right click for context menu
        item.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            showContextMenu(e, this);
        });
        
        // Selection handling
        item.addEventListener('click', function(e) {
            if (!e.ctrlKey && !e.metaKey) {
                // Clear other selections
                document.querySelectorAll('.file-item.selected').forEach(selected => {
                    selected.classList.remove('selected');
                });
            }
            this.classList.toggle('selected');
        });
    });
}

function initializeViewToggle() {
    const gridViewBtn = document.getElementById('gridView');
    const listViewBtn = document.getElementById('listView');
    const filesGrid = document.getElementById('filesGrid');
    
    gridViewBtn.addEventListener('click', function() {
        filesGrid.className = 'files-grid';
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
    });
    
    listViewBtn.addEventListener('click', function() {
        filesGrid.className = 'files-list';
        gridViewBtn.classList.remove('active');
        listViewBtn.classList.add('active');
    });
}

function initializeSorting() {
    const sortSelect = document.getElementById('sortSelect');
    
    sortSelect.addEventListener('change', function() {
        const sortBy = this.value;
        sortFiles(sortBy);
    });
}

function sortFiles(sortBy) {
    const filesGrid = document.getElementById('filesGrid');
    const fileItems = Array.from(filesGrid.querySelectorAll('.file-item'));
    
    fileItems.sort((a, b) => {
        const aName = a.querySelector('.file-name').textContent;
        const bName = b.querySelector('.file-name').textContent;
        
        switch(sortBy) {
            case 'name':
                return aName.localeCompare(bName);
            case 'type':
                return a.dataset.fileType.localeCompare(b.dataset.fileType);
            default:
                return aName.localeCompare(bName);
        }
    });
    
    // Re-append sorted items
    fileItems.forEach(item => filesGrid.appendChild(item));
}

function initializeContextMenu() {
    const contextMenu = document.getElementById('fileContextMenu');
    
    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function() {
        contextMenu.style.display = 'none';
    });
}

function showContextMenu(event, fileItem) {
    const contextMenu = document.getElementById('fileContextMenu');
    
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    
    // Store reference to the file item
    contextMenu.dataset.fileId = fileItem.dataset.fileId;
}

function initializeFilePreview() {
    // Empty state buttons
    const emptyUploadBtn = document.getElementById('emptyUploadBtn');
    const emptyScanBtn = document.getElementById('emptyScanBtn');
    
    if (emptyUploadBtn) {
        emptyUploadBtn.addEventListener('click', function() {
            document.getElementById('newBtn').click();
        });
    }
    
    if (emptyScanBtn) {
        emptyScanBtn.addEventListener('click', function() {
            window.location.href = '{{ url_for("scan_page") }}';
        });
    }
}

function openFilePreview(fileId, fileType) {
    const modal = document.getElementById('previewModal');
    const previewContainer = document.getElementById('previewContainer');
    
    // Show loading
    previewContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading preview...</p></div>';
    modal.style.display = 'flex';
    
    // Load preview content based on file type
    setTimeout(() => {
        previewContainer.innerHTML = `
            <div class="preview-placeholder">
                <i class="fas fa-file-alt fa-5x"></i>
                <p>Preview not available for this file type</p>
                <button class="btn btn-primary" onclick="downloadFile('${fileId}')">
                    <i class="fas fa-download"></i> Download File
                </button>
            </div>
        `;
    }, 500);
}

function downloadFile(fileId) {
    showToast('Download started', 'info');
    // Implement download functionality
}
</script>
{% endblock %}
