{% extends 'base.html' %}

{% block title %}Quản lý tệp - TeleDrive{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="sidebar">
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('browse_files') }}" class="active"><i class="fas fa-home"></i> Trang chủ</a></li>
            <li><a href="#"><i class="fas fa-clock"></i> Gần đây</a></li>
            <li><a href="#"><i class="fas fa-star"></i> Được gắn sao</a></li>
            <li><a href="#"><i class="fas fa-trash"></i> Thùng rác</a></li>
            <li><a href="#"><i class="fas fa-cog"></i> Cài đặt</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="files-header">
            <h2>TeleDrive</h2>
            <div class="actions">
                <button class="btn btn-outline" onclick="openModal('upload-modal')"><i class="fas fa-upload"></i> Tải lên</button>
                <button class="btn btn-outline" onclick="openModal('folder-modal')"><i class="fas fa-folder-plus"></i> Thư mục mới</button>
            </div>
        </div>

        <div class="breadcrumb">
            <a href="{{ url_for('browse_files') }}"><i class="fas fa-home"></i> Trang chủ</a>
            {% if current_path %}
                {% set path_parts = current_path.split('/') %}
                {% set current = '' %}
                {% for part in path_parts %}
                    {% set current = current + part %}
                    <span class="separator">/</span>
                    {% if loop.last %}
                        <span>{{ part }}</span>
                    {% else %}
                        <a href="{{ url_for('browse_files', path=current) }}">{{ part }}</a>
                    {% endif %}
                    {% set current = current + '/' %}
                {% endfor %}
            {% endif %}
        </div>

        {% if parent_path is not none %}
        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('browse_files', path=parent_path) }}" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Quay lại</a>
        </div>
        {% endif %}

        {% if items %}
        <table class="files-table">
            <thead>
                <tr>
                    <th>Tên</th>
                    <th>Kích thước</th>
                    <th>Ngày sửa đổi</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        {% if item.type == 'folder' %}
                        <a href="{{ url_for('browse_files', path=item.path) }}">
                            <i class="fas fa-folder folder-icon"></i> {{ item.name }}
                        </a>
                        {% else %}
                        <i class="fas fa-file file-icon"></i> {{ item.name }}
                        {% endif %}
                    </td>
                    <td>{{ item.size }}</td>
                    <td>{{ item.date }}</td>
                    <td class="file-actions">
                        {% if item.type == 'file' %}
                        <a href="{{ url_for('download_file', file_path=item.path) }}" title="Tải xuống">
                            <i class="fas fa-download"></i>
                        </a>
                        {% endif %}
                        <a href="{{ url_for('delete_item', file_path=item.path) }}" class="delete" title="Xóa" onclick="return confirm('Bạn có chắc chắn muốn xóa {{ item.name }}?');">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3>Thư mục trống</h3>
            <p>Thư mục này chưa có tệp hay thư mục nào.</p>
            <div class="empty-actions">
                <button class="btn btn-primary" onclick="openModal('upload-modal')"><i class="fas fa-upload"></i> Tải lên tệp</button>
                <button class="btn btn-outline" onclick="openModal('folder-modal')"><i class="fas fa-folder-plus"></i> Tạo thư mục</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Upload -->
<div id="upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tải lên tệp</h3>
            <button class="close-modal" onclick="closeModal('upload-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="current_path" value="{{ current_path }}">
                <div class="form-file" id="drop-area">
                    <div class="form-file-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p>Kéo và thả tệp vào đây hoặc nhấp để chọn tệp</p>
                    <input type="file" name="file" id="file-input" required>
                </div>
                <div id="file-name" style="margin-top: 10px; text-align: center;"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('upload-modal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Tải lên</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Create Folder -->
<div id="folder-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tạo thư mục mới</h3>
            <button class="close-modal" onclick="closeModal('folder-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form action="{{ url_for('create_folder') }}" method="post">
                <input type="hidden" name="current_path" value="{{ current_path }}">
                <div class="form-group">
                    <input type="text" id="folder_name" name="folder_name" class="form-control" placeholder="Tên thư mục" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('folder-modal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">Tạo thư mục</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function openModal(id) {
        document.getElementById(id).classList.add('show');
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }
    
    // Afficher le nom du fichier sélectionné
    document.getElementById('file-input').addEventListener('change', function(e) {
        var fileName = e.target.files[0].name;
        document.getElementById('file-name').textContent = 'Tệp đã chọn: ' + fileName;
    });
    
    // Fermer les modals quand on clique en dehors
    window.addEventListener('click', function(e) {
        var modals = document.getElementsByClassName('modal');
        for (var i = 0; i < modals.length; i++) {
            if (e.target === modals[i]) {
                modals[i].classList.remove('show');
            }
        }
    });
    
    // Support drag and drop pour l'upload
    var dropArea = document.getElementById('drop-area');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.style.borderColor = 'var(--primary-color)';
        dropArea.style.backgroundColor = 'rgba(33, 150, 243, 0.05)';
    }
    
    function unhighlight() {
        dropArea.style.borderColor = 'var(--border-color)';
        dropArea.style.backgroundColor = '';
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        var dt = e.dataTransfer;
        var files = dt.files;
        
        if (files.length > 0) {
            document.getElementById('file-input').files = files;
            document.getElementById('file-name').textContent = 'Tệp đã chọn: ' + files[0].name;
        }
    }
</script>
{% endblock %} 