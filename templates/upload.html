{% extends "base.html" %}

{% block title %}Upload - TeleDrive{% endblock %}

{% block content %}
<div class="upload-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-left">
            <h1>Upload Files</h1>
            <div class="breadcrumb">
                <span>Channel:</span>
                <span class="channel-name" id="currentChannel">{{ channel or 'Select a channel' }}</span>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showChannelSelector()">
                <i data-feather="folder"></i>
                Change Channel
            </button>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="upload-container">
        <div class="upload-form">
            <!-- Channel Selection -->
            {% if not channel %}
            <div class="form-section">
                <h3>Select Channel</h3>
                <div class="form-group">
                    <label for="channelInput">Channel Username or ID</label>
                    <input type="text" id="channelInput" placeholder="@mychannel or channel_id" class="form-input">
                    <small class="form-help">Enter the channel username (with @) or channel ID</small>
                </div>
                <button class="btn btn-primary" onclick="setChannel()">
                    <i data-feather="check"></i>
                    Set Channel
                </button>
            </div>
            {% endif %}

            <!-- File Upload Section -->
            <div class="form-section" id="uploadSection" {% if not channel %}style="display: none;"{% endif %}>
                <h3>Upload Files</h3>
                
                <!-- Drag & Drop Area -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i data-feather="upload-cloud"></i>
                    </div>
                    <h4>Drag & drop files here</h4>
                    <p>or click to browse files</p>
                    <input type="file" id="fileInput" multiple hidden>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <i data-feather="folder"></i>
                        Browse Files
                    </button>
                </div>

                <!-- Caption Input -->
                <div class="form-group">
                    <label for="captionInput">Caption (Optional)</label>
                    <textarea id="captionInput" placeholder="Enter a caption for your files..." class="form-textarea" rows="3"></textarea>
                </div>

                <!-- Upload Queue -->
                <div class="upload-queue" id="uploadQueue" style="display: none;">
                    <h4>Upload Queue</h4>
                    <div class="queue-list" id="queueList">
                        <!-- Queue items will be added here -->
                    </div>
                    
                    <div class="queue-actions">
                        <button class="btn btn-secondary" onclick="clearQueue()">
                            <i data-feather="trash-2"></i>
                            Clear Queue
                        </button>
                        <button class="btn btn-primary" onclick="startUpload()" id="uploadBtn">
                            <i data-feather="upload"></i>
                            Upload All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Progress -->
        <div class="upload-progress" id="uploadProgress" style="display: none;">
            <h3>Uploading Files</h3>
            <div class="progress-list" id="progressList">
                <!-- Progress items will be added here -->
            </div>
        </div>

        <!-- Upload Results -->
        <div class="upload-results" id="uploadResults" style="display: none;">
            <h3>Upload Complete</h3>
            <div class="results-summary" id="resultsSummary">
                <!-- Results summary will be added here -->
            </div>
            <div class="results-list" id="resultsList">
                <!-- Results will be added here -->
            </div>
            <div class="results-actions">
                <button class="btn btn-secondary" onclick="resetUpload()">
                    <i data-feather="refresh-cw"></i>
                    Upload More
                </button>
                <button class="btn btn-primary" onclick="viewFiles()">
                    <i data-feather="folder"></i>
                    View Files
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Channel Selector Modal -->
<div class="modal" id="channelModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Select Channel</h3>
            <button class="modal-close" onclick="closeModal('channelModal')">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="modalChannelInput">Channel Username or ID</label>
                <input type="text" id="modalChannelInput" placeholder="@mychannel or channel_id" class="form-input" value="{{ channel or '' }}">
                <small class="form-help">Enter the channel username (with @) or channel ID</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('channelModal')">Cancel</button>
            <button class="btn btn-primary" onclick="setChannelFromModal()">Set Channel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentChannel = '{{ channel or "" }}';
let uploadQueue = [];
let isUploading = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupDragAndDrop();
    setupFileInput();
    
    if (currentChannel) {
        document.getElementById('currentChannel').textContent = currentChannel;
    }
});

function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        
        const files = Array.from(e.dataTransfer.files);
        addFilesToQueue(files);
    });
    
    uploadArea.addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });
}

function setupFileInput() {
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', function() {
        const files = Array.from(this.files);
        addFilesToQueue(files);
    });
}

function addFilesToQueue(files) {
    if (!currentChannel) {
        showToast('Please select a channel first', 'error');
        return;
    }
    
    files.forEach(file => {
        const queueItem = {
            id: Date.now() + Math.random(),
            file: file,
            name: file.name,
            size: file.size,
            sizeFormatted: formatFileSize(file.size),
            status: 'pending'
        };
        
        uploadQueue.push(queueItem);
    });
    
    updateQueueDisplay();
    showToast(`Added ${files.length} file(s) to queue`, 'success');
}

function updateQueueDisplay() {
    const queueContainer = document.getElementById('uploadQueue');
    const queueList = document.getElementById('queueList');
    
    if (uploadQueue.length === 0) {
        queueContainer.style.display = 'none';
        return;
    }
    
    queueContainer.style.display = 'block';
    
    queueList.innerHTML = uploadQueue.map(item => `
        <div class="queue-item" data-id="${item.id}">
            <div class="item-icon">
                <i data-feather="file"></i>
            </div>
            <div class="item-info">
                <h5 class="item-name">${item.name}</h5>
                <p class="item-size">${item.sizeFormatted}</p>
            </div>
            <div class="item-status">
                <span class="status-badge status-${item.status}">${item.status}</span>
            </div>
            <div class="item-actions">
                <button class="action-btn" onclick="removeFromQueue('${item.id}')" title="Remove">
                    <i data-feather="x"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    feather.replace();
}

function removeFromQueue(itemId) {
    uploadQueue = uploadQueue.filter(item => item.id !== itemId);
    updateQueueDisplay();
}

function clearQueue() {
    uploadQueue = [];
    updateQueueDisplay();
}

function setChannel() {
    const channel = document.getElementById('channelInput').value.trim();
    if (channel) {
        currentChannel = channel;
        document.getElementById('currentChannel').textContent = channel;
        document.getElementById('uploadSection').style.display = 'block';
        
        // Update URL
        const url = new URL(window.location);
        url.searchParams.set('channel', channel);
        window.history.pushState({}, '', url);
        
        showToast('Channel set successfully', 'success');
    } else {
        showToast('Please enter a channel username or ID', 'error');
    }
}

function showChannelSelector() {
    document.getElementById('modalChannelInput').value = currentChannel;
    document.getElementById('channelModal').classList.add('active');
}

function setChannelFromModal() {
    const channel = document.getElementById('modalChannelInput').value.trim();
    if (channel) {
        currentChannel = channel;
        document.getElementById('currentChannel').textContent = channel;
        document.getElementById('uploadSection').style.display = 'block';
        closeModal('channelModal');
        
        // Update URL
        const url = new URL(window.location);
        url.searchParams.set('channel', channel);
        window.history.pushState({}, '', url);
        
        showToast('Channel updated successfully', 'success');
    } else {
        showToast('Please enter a channel username or ID', 'error');
    }
}

async function startUpload() {
    if (uploadQueue.length === 0) {
        showToast('No files to upload', 'error');
        return;
    }
    
    if (!currentChannel) {
        showToast('Please select a channel first', 'error');
        return;
    }
    
    if (isUploading) {
        return;
    }
    
    isUploading = true;
    document.getElementById('uploadBtn').disabled = true;
    
    // Show progress section
    document.getElementById('uploadProgress').style.display = 'block';
    
    const caption = document.getElementById('captionInput').value.trim();
    const progressList = document.getElementById('progressList');
    const results = [];
    
    // Create progress items
    progressList.innerHTML = uploadQueue.map(item => `
        <div class="progress-item" data-id="${item.id}">
            <div class="item-info">
                <h5 class="item-name">${item.name}</h5>
                <p class="item-size">${item.sizeFormatted}</p>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-status">Waiting...</div>
        </div>
    `).join('');
    
    // Upload files one by one
    for (let i = 0; i < uploadQueue.length; i++) {
        const item = uploadQueue[i];
        const progressItem = document.querySelector(`[data-id="${item.id}"]`);
        const progressFill = progressItem.querySelector('.progress-fill');
        const progressStatus = progressItem.querySelector('.progress-status');
        
        try {
            progressStatus.textContent = 'Uploading...';
            progressFill.style.width = '50%';
            
            const formData = new FormData();
            formData.append('file', item.file);
            formData.append('caption', caption);
            
            const response = await fetch(`/api/upload/${encodeURIComponent(currentChannel)}`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                progressFill.style.width = '100%';
                progressStatus.textContent = 'Completed';
                progressStatus.classList.add('success');
                results.push({...result, filename: item.name, success: true});
            } else {
                progressFill.style.width = '100%';
                progressStatus.textContent = 'Failed';
                progressStatus.classList.add('error');
                results.push({...result, filename: item.name, success: false});
            }
        } catch (error) {
            progressFill.style.width = '100%';
            progressStatus.textContent = 'Error';
            progressStatus.classList.add('error');
            results.push({
                filename: item.name,
                success: false,
                message: error.message
            });
        }
    }
    
    // Show results
    showUploadResults(results);
    
    isUploading = false;
    document.getElementById('uploadBtn').disabled = false;
}

function showUploadResults(results) {
    const successCount = results.filter(r => r.success).length;
    const failCount = results.length - successCount;
    
    document.getElementById('uploadResults').style.display = 'block';
    
    // Summary
    document.getElementById('resultsSummary').innerHTML = `
        <div class="summary-stats">
            <div class="stat-item success">
                <div class="stat-number">${successCount}</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number">${failCount}</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
    `;
    
    // Results list
    document.getElementById('resultsList').innerHTML = results.map(result => `
        <div class="result-item ${result.success ? 'success' : 'error'}">
            <div class="result-icon">
                <i data-feather="${result.success ? 'check-circle' : 'x-circle'}"></i>
            </div>
            <div class="result-info">
                <h5 class="result-name">${result.filename}</h5>
                <p class="result-message">${result.message}</p>
            </div>
        </div>
    `).join('');
    
    feather.replace();
}

function resetUpload() {
    uploadQueue = [];
    isUploading = false;
    
    document.getElementById('uploadQueue').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResults').style.display = 'none';
    document.getElementById('captionInput').value = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadBtn').disabled = false;
}

function viewFiles() {
    if (currentChannel) {
        window.location.href = `/files?channel=${encodeURIComponent(currentChannel)}`;
    }
}

function formatFileSize(bytes) {
    const sizes = ['B', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 B';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
    }
});

// Enter key support for channel inputs
document.getElementById('channelInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        setChannel();
    }
});

document.getElementById('modalChannelInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        setChannelFromModal();
    }
});
</script>
{% endblock %}
