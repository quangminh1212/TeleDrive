{% extends "base.html" %}

{% block title %}Analytics - TeleDrive{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Analytics Dashboard</h1>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="refreshAnalytics()">
            <span class="material-icons">refresh</span>
            Refresh Data
        </button>
        <button class="btn btn-secondary" onclick="exportReport()">
            <span class="material-icons">download</span>
            Export Report
        </button>
    </div>
</div>

<!-- Overview Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">folder</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-files">-</div>
            <div class="stat-label">Total Files</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">storage</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-size">-</div>
            <div class="stat-label">Total Storage</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">share</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-shares">-</div>
            <div class="stat-label">Active Shares</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <span class="material-icons">scanner</span>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="total-scans">-</div>
            <div class="stat-label">Total Scans</div>
        </div>
    </div>
</div>

<!-- Analytics Tabs -->
<div class="analytics-container">
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
        <button class="tab-btn" onclick="showTab('usage')">Usage</button>
        <button class="tab-btn" onclick="showTab('sharing')">Sharing</button>
        <button class="tab-btn" onclick="showTab('storage')">Storage</button>
    </div>

    <!-- Overview Tab -->
    <div class="tab-content active" id="overview-tab">
        <div class="analytics-grid">
            <div class="chart-card">
                <h3>File Types Distribution</h3>
                <div class="chart-container">
                    <canvas id="fileTypesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Recent Activity</h3>
                <div class="activity-list" id="recent-activity">
                    <!-- Recent activity items will be loaded here -->
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Top Channels</h3>
                <div class="channel-list" id="top-channels">
                    <!-- Top channels will be loaded here -->
                </div>
            </div>
            
            <div class="chart-card">
                <h3>System Health</h3>
                <div class="health-metrics" id="system-health">
                    <!-- System health metrics will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Tab -->
    <div class="tab-content" id="usage-tab">
        <div class="analytics-grid">
            <div class="chart-card full-width">
                <h3>Files Created Over Time</h3>
                <div class="chart-container">
                    <canvas id="filesTimeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Scan Activity</h3>
                <div class="chart-container">
                    <canvas id="scanActivityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Usage Statistics</h3>
                <div class="usage-stats" id="usage-stats">
                    <!-- Usage statistics will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sharing Tab -->
    <div class="tab-content" id="sharing-tab">
        <div class="analytics-grid">
            <div class="chart-card">
                <h3>Share Types</h3>
                <div class="chart-container">
                    <canvas id="shareTypesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Most Accessed Shares</h3>
                <div class="shares-list" id="top-shares">
                    <!-- Top shares will be loaded here -->
                </div>
            </div>
            
            <div class="chart-card full-width">
                <h3>Recent Share Access</h3>
                <div class="access-log" id="recent-access">
                    <!-- Recent access log will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Tab -->
    <div class="tab-content" id="storage-tab">
        <div class="analytics-grid">
            <div class="chart-card">
                <h3>Storage by Type</h3>
                <div class="chart-container">
                    <canvas id="storageTypeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Storage by Folder</h3>
                <div class="folder-storage" id="folder-storage">
                    <!-- Folder storage will be loaded here -->
                </div>
            </div>
            
            <div class="chart-card full-width">
                <h3>Largest Files</h3>
                <div class="large-files" id="largest-files">
                    <!-- Largest files will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-top: 24px;
}

.tab-navigation {
    display: flex;
    border-bottom: 1px solid #e0e0e0;
    background: #f8f9fa;
}

.tab-btn {
    padding: 16px 24px;
    border: none;
    background: none;
    font-size: 14px;
    font-weight: 500;
    color: #5f6368;
    cursor: pointer;
    transition: all 0.2s;
}

.tab-btn:hover {
    background: #e8f0fe;
    color: #1a73e8;
}

.tab-btn.active {
    background: white;
    color: #1a73e8;
    border-bottom: 2px solid #1a73e8;
}

.tab-content {
    display: none;
    padding: 24px;
}

.tab-content.active {
    display: block;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
}

.chart-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
}

.chart-card.full-width {
    grid-column: 1 / -1;
}

.chart-card h3 {
    margin-bottom: 16px;
    font-size: 16px;
    font-weight: 500;
    color: #202124;
}

.chart-container {
    position: relative;
    height: 300px;
}

.activity-list, .channel-list, .shares-list {
    max-height: 300px;
    overflow-y: auto;
}

.activity-item, .channel-item, .share-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e0e0e0;
}

.activity-item:last-child,
.channel-item:last-child,
.share-item:last-child {
    border-bottom: none;
}

.health-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.health-metric {
    text-align: center;
    padding: 16px;
    background: white;
    border-radius: 6px;
}

.health-metric .metric-value {
    font-size: 24px;
    font-weight: 600;
    color: #1a73e8;
}

.health-metric .metric-label {
    font-size: 12px;
    color: #5f6368;
    margin-top: 4px;
}

.usage-stats {
    display: grid;
    gap: 12px;
}

.usage-stat {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    background: white;
    border-radius: 6px;
}

.folder-storage, .large-files {
    max-height: 400px;
    overflow-y: auto;
}

.folder-item, .file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 6px;
    margin-bottom: 8px;
}

.access-log {
    max-height: 300px;
    overflow-y: auto;
}

.access-item {
    display: grid;
    grid-template-columns: 1fr 100px 120px 100px;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 14px;
}

@media (max-width: 768px) {
    .tab-navigation {
        flex-wrap: wrap;
    }
    
    .tab-btn {
        flex: 1;
        min-width: 120px;
    }
    
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .health-metrics {
        grid-template-columns: 1fr;
    }
    
    .access-item {
        grid-template-columns: 1fr;
        gap: 8px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

// Initialize analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
    
    // Load tab-specific data
    loadTabData(tabName);
}

function loadAnalytics() {
    loadDashboardStats();
    loadTabData('overview');
}

function loadDashboardStats() {
    fetch('/api/analytics/dashboard')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboardStats(data.stats);
            }
        })
        .catch(error => console.error('Error loading dashboard stats:', error));
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'overview':
            loadOverviewData();
            break;
        case 'usage':
            loadUsageData();
            break;
        case 'sharing':
            loadSharingData();
            break;
        case 'storage':
            loadStorageData();
            break;
    }
}

function updateDashboardStats(stats) {
    document.getElementById('total-files').textContent = stats.total_files.toLocaleString();
    document.getElementById('total-size').textContent = formatFileSize(stats.total_size);
    document.getElementById('total-shares').textContent = stats.total_shares || 0;
    document.getElementById('total-scans').textContent = stats.total_scans.toLocaleString();
}

function loadOverviewData() {
    // Load file types chart, recent activity, etc.
    fetch('/api/analytics/dashboard')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createFileTypesChart(data.stats.file_types);
                updateRecentActivity(data.stats.recent_files);
            }
        });
}

function createFileTypesChart(fileTypes) {
    const ctx = document.getElementById('fileTypesChart').getContext('2d');
    
    if (charts.fileTypes) {
        charts.fileTypes.destroy();
    }
    
    const labels = Object.keys(fileTypes);
    const data = Object.values(fileTypes).map(type => type.count);
    
    charts.fileTypes = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#1a73e8', '#34a853', '#fbbc04', '#ea4335', '#9aa0a6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function updateRecentActivity(recentFiles) {
    const container = document.getElementById('recent-activity');
    container.innerHTML = recentFiles.slice(0, 10).map(file => `
        <div class="activity-item">
            <div>
                <div style="font-weight: 500;">${file.filename}</div>
                <div style="font-size: 12px; color: #5f6368;">${formatFileSize(file.file_size)}</div>
            </div>
            <div style="font-size: 12px; color: #5f6368;">
                ${new Date(file.created_at).toLocaleDateString()}
            </div>
        </div>
    `).join('');
}

function refreshAnalytics() {
    showLoading();
    loadAnalytics();
    setTimeout(hideLoading, 1000);
}

function exportReport() {
    // Implementation for exporting analytics report
    showToast('Export functionality coming soon!', 'info');
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Additional functions for other tabs would be implemented here
function loadUsageData() {
    // Implementation for usage analytics
}

function loadSharingData() {
    // Implementation for sharing analytics
}

function loadStorageData() {
    // Implementation for storage analytics
}
</script>
{% endblock %}
