<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleDrive - Đăng nhập Telegram API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #212529;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }
        .login-container {
            max-width: 450px;
            margin: 50px auto;
            padding: 30px;
            background-color: #2c3034;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .telegram-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }
        .btn-telegram {
            background-color: #0088cc;
            color: white;
            border: none;
            font-weight: 500;
        }
        .btn-telegram:hover {
            background-color: #0077b5;
            color: white;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .code-input {
            letter-spacing: 0.5em;
            text-align: center;
            font-weight: bold;
            background-color: #343a40;
            color: #fff;
            border-color: #495057;
        }
        .status-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #343a40;
            display: none;
        }
        .status-success {
            background-color: #28a745;
            color: #fff;
        }
        .status-error {
            background-color: #dc3545;
            color: #fff;
        }
        .error-details {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #343a40;
            display: none;
        }
        .error-details .accordion {
            margin-bottom: 15px;
        }
        .error-details .accordion-item {
            border: none;
            border-radius: 0;
            background-color: #2c3034;
        }
        .error-details .accordion-button {
            font-weight: bold;
            color: #0d6efd;
            background-color: #343a40;
        }
        .error-details .accordion-button:focus {
            box-shadow: none;
        }
        .error-details .accordion-button:not(.collapsed) {
            color: #0d6efd;
            background-color: #343a40;
        }
        .error-details .accordion-body {
            padding: 15px;
            background-color: #2c3034;
        }
        .error-details .accordion-body p {
            margin-bottom: 10px;
        }
        .form-control {
            background-color: #343a40;
            color: #fff;
            border-color: #495057;
        }
        .form-control:focus {
            background-color: #343a40;
            color: #fff;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .form-text {
            color: #adb5bd;
        }
        .input-group-text {
            background-color: #212529;
            color: #fff;
            border-color: #495057;
        }
        .phone-example {
            background-color: #343a40;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .country-select {
            max-height: 300px;
            overflow-y: auto;
            background-color: #343a40;
            border-color: #495057;
        }
        .country-option {
            display: flex;
            align-items: center;
            padding: 8px 10px;
        }
        .country-option:hover {
            background-color: #212529;
        }
        .country-flag {
            width: 20px;
            margin-right: 10px;
        }
        .country-code {
            color: #adb5bd;
            margin-left: 5px;
        }
        .input-group-text.country-code-btn {
            min-width: 90px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 8px;
            cursor: pointer;
            background-color: #212529;
        }
        .selected-flag {
            width: 20px;
            margin-right: 5px;
        }
        .dropdown-item {
            color: #fff;
        }
        .dropdown-item:hover, .dropdown-item:focus {
            color: #fff;
            background-color: #212529;
        }
        .dropdown-menu {
            background-color: #343a40;
            border-color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-container">
            <div class="text-center mb-4">
                <img src="https://telegram.org/img/t_logo.svg" alt="Telegram Logo" class="telegram-logo">
                <h2>TeleDrive - Đăng nhập Telegram</h2>
                <p class="text-muted">Sử dụng tài khoản Telegram của bạn để tự động đồng bộ file</p>
            </div>

            <div class="status-container" id="statusContainer">
                <div class="alert d-flex align-items-center" id="statusAlert">
                    <div class="spinner-border spinner-border-sm me-2" role="status" id="statusSpinner"></div>
                    <span id="statusMessage">Đang xử lý...</span>
                </div>
            </div>

            <div class="error-details d-none" id="errorDetails">
                <div class="accordion" id="errorAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#errorDetailsCollapse">
                                Thông tin lỗi chi tiết
                            </button>
                        </h2>
                        <div id="errorDetailsCollapse" class="accordion-collapse collapse" data-bs-parent="#errorAccordion">
                            <div class="accordion-body">
                                <p id="errorHelp" class="text-muted"></p>
                                <code id="errorCode" class="d-block p-3 bg-dark text-light" style="white-space: pre-wrap; font-size: 0.8rem;"></code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-steps">
                <!-- Bước 1: Nhập số điện thoại -->
                <div class="form-step active" id="phoneStep">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Số điện thoại Telegram của bạn</label>
                        <div class="input-group">
                            <button class="input-group-text country-code-btn" type="button" id="countryCodeBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="https://flagcdn.com/w20/vn.png" alt="VN" class="selected-flag" id="selectedFlag">
                                <span id="selectedCountryCodeText">+84</span>
                                <i class="bi bi-caret-down-fill small"></i>
                            </button>
                            <ul class="dropdown-menu country-select" id="countryDropdown">
                                <!-- Danh sách quốc gia sẽ được thêm bằng JavaScript -->
                            </ul>
                            <input type="tel" class="form-control" id="phoneNumber" placeholder="Nhập số điện thoại">
                        </div>
                        <div class="form-text">Nhập đầy đủ số điện thoại (có thể bắt đầu bằng số 0)</div>
                        
                        <div class="phone-example mt-2">
                            <strong>Hướng dẫn nhập:</strong><br>
                            • Có thể nhập <code>0936374950</code> hoặc <code>936374950</code> (tự động chuyển đổi)<br>
                            • Mã quốc gia Việt Nam (+84) được chọn mặc định<br>
                            • Chọn mã quốc gia khác nếu không dùng số Việt Nam
                        </div>
                    </div>
                    <div class="d-grid mt-3">
                        <button type="button" id="sendCodeBtn" class="btn btn-telegram">
                            <i class="bi bi-telegram me-2"></i> Gửi mã xác nhận
                        </button>
                    </div>
                </div>

                <!-- Bước 2: Nhập mã xác nhận -->
                <div class="form-step" id="codeStep">
                    <div class="mb-3">
                        <label for="confirmCode" class="form-label">Mã xác nhận</label>
                        <input type="text" class="form-control code-input" id="confirmCode" placeholder="12345" maxlength="5">
                        <div class="form-text">Mã xác nhận đã được gửi đến Telegram của bạn</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" id="confirmCodeBtn" class="btn btn-telegram">
                            <i class="bi bi-check-circle me-2"></i> Xác nhận mã
                        </button>
                        <button type="button" id="backToPhoneBtn" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i> Quay lại
                        </button>
                    </div>
                </div>

                <!-- Bước 3: Nhập mật khẩu hai lớp (nếu cần) -->
                <div class="form-step" id="passwordStep">
                    <div class="mb-3">
                        <label for="twoFactorPassword" class="form-label">Mật khẩu hai lớp</label>
                        <input type="password" class="form-control" id="twoFactorPassword">
                        <div class="form-text">Tài khoản của bạn được bảo vệ bằng mật khẩu hai lớp</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" id="confirmPasswordBtn" class="btn btn-telegram">
                            <i class="bi bi-unlock me-2"></i> Đăng nhập
                        </button>
                        <button type="button" id="backToCodeBtn" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i> Quay lại
                        </button>
                    </div>
                </div>

                <!-- Bước 4: Đăng nhập thành công -->
                <div class="form-step" id="successStep">
                    <div class="text-center mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 48px;"></i>
                        <h4 class="mt-3">Đăng nhập thành công!</h4>
                        <p>Bạn đã đăng nhập thành công vào tài khoản Telegram.</p>
                    </div>
                    <div class="d-grid">
                        <a href="/" class="btn btn-primary">
                            <i class="bi bi-house-door me-2"></i> Quay lại TeleDrive
                        </a>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center">
                <p class="text-muted small">
                    <i class="bi bi-info-circle"></i> 
                    TeleDrive sẽ sử dụng tài khoản Telegram của bạn để tự động đồng bộ file.
                    Chúng tôi không lưu trữ mật khẩu của bạn.
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Biến lưu trữ dữ liệu
        let phone = '';
        let phoneCodeHash = '';
        let selectedCountryCode = '84'; // Mặc định: Việt Nam
        
        // Phần tử DOM
        const phoneStep = document.getElementById('phoneStep');
        const codeStep = document.getElementById('codeStep');
        const passwordStep = document.getElementById('passwordStep');
        const successStep = document.getElementById('successStep');
        const statusContainer = document.getElementById('statusContainer');
        const statusMessage = document.getElementById('statusMessage');
        const errorDetails = document.getElementById('errorDetails');
        const errorHelp = document.getElementById('errorHelp');
        const errorCode = document.getElementById('errorCode');
        const countryDropdown = document.getElementById('countryDropdown');
        const countryCodeBtn = document.getElementById('countryCodeBtn');
        const selectedFlag = document.getElementById('selectedFlag');
        const selectedCountryCodeText = document.getElementById('selectedCountryCodeText');
        
        // Danh sách mã quốc gia phổ biến với cờ
        const countries = [
            { code: '84', name: 'Việt Nam', flag: 'vn' },
            { code: '1', name: 'Hoa Kỳ', flag: 'us' },
            { code: '86', name: 'Trung Quốc', flag: 'cn' },
            { code: '82', name: 'Hàn Quốc', flag: 'kr' },
            { code: '81', name: 'Nhật Bản', flag: 'jp' },
            { code: '65', name: 'Singapore', flag: 'sg' },
            { code: '66', name: 'Thái Lan', flag: 'th' },
            { code: '60', name: 'Malaysia', flag: 'my' },
            { code: '62', name: 'Indonesia', flag: 'id' },
            { code: '63', name: 'Philippines', flag: 'ph' },
            { code: '44', name: 'Anh', flag: 'gb' },
            { code: '33', name: 'Pháp', flag: 'fr' },
            { code: '49', name: 'Đức', flag: 'de' },
            { code: '39', name: 'Ý', flag: 'it' },
            { code: '34', name: 'Tây Ban Nha', flag: 'es' },
            { code: '7', name: 'Nga', flag: 'ru' },
            { code: '61', name: 'Úc', flag: 'au' },
            { code: '64', name: 'New Zealand', flag: 'nz' },
            { code: '91', name: 'Ấn Độ', flag: 'in' },
            { code: '55', name: 'Brazil', flag: 'br' },
            { code: '52', name: 'Mexico', flag: 'mx' },
            { code: '971', name: 'UAE', flag: 'ae' },
            { code: '966', name: 'Ả Rập Saudi', flag: 'sa' },
            { code: '20', name: 'Ai Cập', flag: 'eg' },
            { code: '27', name: 'Nam Phi', flag: 'za' }
        ];

        // Thêm các quốc gia vào dropdown
        countries.forEach(country => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <a class="dropdown-item country-option" href="#" data-code="${country.code}" data-flag="${country.flag}">
                    <img src="https://flagcdn.com/w20/${country.flag}.png" alt="${country.name}" class="country-flag">
                    ${country.name} <span class="country-code">+${country.code}</span>
                </a>
            `;
            countryDropdown.appendChild(listItem);
            
            // Thêm sự kiện click cho mỗi quốc gia
            listItem.querySelector('a').addEventListener('click', function(e) {
                e.preventDefault();
                const code = this.getAttribute('data-code');
                const flag = this.getAttribute('data-flag');
                
                selectedCountryCode = code;
                selectedFlag.src = `https://flagcdn.com/w20/${flag}.png`;
                selectedCountryCodeText.textContent = `+${code}`;
            });
        });
        
        // Nút gửi mã
        document.getElementById('sendCodeBtn').addEventListener('click', async function() {
            const phoneInput = document.getElementById('phoneNumber');
            let phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                showError('Vui lòng nhập số điện thoại');
                return;
            }
            
            // Xử lý số điện thoại bắt đầu bằng số 0 cho Việt Nam
            if (selectedCountryCode === '84' && phoneNumber.startsWith('0')) {
                phoneNumber = phoneNumber.substring(1);
            }
            
            // Thêm mã quốc gia đã chọn vào số điện thoại
            phone = `+${selectedCountryCode}${phoneNumber}`;
            
            // Hiển thị trạng thái đang xử lý
            showStatus('Đang gửi mã xác nhận...', 'info');
            console.log('Sending code to phone:', phone);
            
            try {
                const response = await fetch('/api/telegram/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone })
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (response.ok && data.success) {
                    // Lưu phone_code_hash
                    phoneCodeHash = data.phone_code_hash;
                    
                    // Chuyển sang bước nhập mã
                    showStep(codeStep);
                    hideStatus();
                } else {
                    const errorMsg = data.error || 'Không thể gửi mã xác nhận';
                    showError(errorMsg);
                    
                    // Hiển thị gợi ý khắc phục
                    let helpText = '';
                    if (errorMsg.includes('số điện thoại không hợp lệ') || errorMsg.includes('PHONE_NUMBER_INVALID')) {
                        helpText = 'Vui lòng kiểm tra lại số điện thoại. Định dạng đúng: +84123456789 (có dấu +, mã quốc gia, không có số 0 đầu).';
                    } else if (errorMsg.includes('FLOOD_WAIT')) {
                        const waitMatch = errorMsg.match(/(\d+) giây/);
                        const waitTime = waitMatch ? waitMatch[1] : 'một khoảng thời gian';
                        helpText = `Telegram giới hạn số lần gửi mã. Vui lòng đợi ${waitTime} giây và thử lại sau.`;
                        
                        // Hiển thị thông báo đặc biệt cho lỗi flood
                        errorHelp.innerHTML = `
                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle-fill"></i> Lỗi giới hạn yêu cầu</h6>
                                <p>Telegram hạn chế số lần yêu cầu mã xác nhận từ một số điện thoại trong một khoảng thời gian.</p>
                                <p>Bạn cần đợi <strong>${waitTime} giây</strong> trước khi có thể gửi lại yêu cầu.</p>
                                <hr>
                                <p class="mb-0">Bạn có thể đóng cửa sổ này và thử lại sau.</p>
                            </div>
                        `;
                    } else if (data.details) {
                        errorCode.textContent = JSON.stringify(data.details, null, 2);
                    }
                    if (!errorMsg.includes('FLOOD_WAIT')) {
                        errorHelp.textContent = helpText || errorMsg;
                    }
                }
            } catch (error) {
                console.error('Error sending code:', error);
                showError('Lỗi kết nối: ' + error.message);
            }
        });
        
        // Format điện thoại trực tiếp khi nhập
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            // Giữ nguyên số 0 ở đầu (sẽ tự động xử lý khi gửi)
            e.target.value = value;
        });
        
        // Nút xác nhận mã
        document.getElementById('confirmCodeBtn').addEventListener('click', async function() {
            const codeInput = document.getElementById('confirmCode');
            const code = codeInput.value.trim();
            
            if (!code) {
                showError('Vui lòng nhập mã xác nhận');
                return;
            }
            
            showStatus('Đang xác thực...', 'info');
            console.log('Confirming code:', code, 'for phone:', phone);
            
            try {
                // Kiểm tra xem số điện thoại đã có dấu + chưa
                const formattedPhone = phone.startsWith('+') ? phone : '+' + phone;
                
                const response = await fetch('/api/telegram/sign-in', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phoneNumber: formattedPhone,
                        code,
                        phoneCodeHash
                    })
                });
                
                const data = await response.json();
                console.log('Sign-in response:', data);
                
                if (response.ok && data.success) {
                    // Đăng nhập thành công
                    showStatus('Đăng nhập thành công!', 'success');
                    
                    // Lưu session
                    if (data.sessionId) {
                        localStorage.setItem('sessionId', data.sessionId);
                        localStorage.setItem('username', data.user.name);
                        localStorage.setItem('telegramLoggedIn', 'true');
                    }
                    
                    // Chuyển sang bước thành công
                    setTimeout(() => {
                        showStep(successStep);
                        hideStatus();
                        
                        // Thông báo cho cửa sổ cha
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage({ type: 'telegram_api_login_success' }, '*');
                        }
                        
                        // Tự động đóng sau 3 giây
                        setTimeout(() => {
                            window.close();
                        }, 3000);
                    }, 1000);
                } else if (data.error === 'PASSWORD_NEEDED') {
                    // Yêu cầu mật khẩu hai lớp
                    showStep(passwordStep);
                    hideStatus();
                } else {
                    const errorMsg = data.error || 'Mã xác nhận không đúng';
                    showError(errorMsg);
                    
                    // Hiển thị gợi ý khắc phục
                    let helpText = '';
                    if (errorMsg.includes('PHONE_CODE_INVALID')) {
                        helpText = 'Mã xác nhận không đúng. Vui lòng kiểm tra lại mã Telegram đã gửi cho bạn.';
                    } else if (errorMsg.includes('PHONE_CODE_EXPIRED')) {
                        helpText = 'Mã xác nhận đã hết hạn. Vui lòng quay lại và yêu cầu mã mới.';
                    } else if (data.details) {
                        errorCode.textContent = JSON.stringify(data.details, null, 2);
                    }
                    errorHelp.textContent = helpText || errorMsg;
                }
            } catch (error) {
                console.error('Error confirming code:', error);
                showError('Lỗi kết nối: ' + error.message);
            }
        });
        
        // Nút quay lại số điện thoại
        document.getElementById('backToPhoneBtn').addEventListener('click', function() {
            showStep(phoneStep);
        });
        
        // Nút quay lại mã xác nhận
        document.getElementById('backToCodeBtn').addEventListener('click', function() {
            showStep(codeStep);
        });
        
        // Nút xác nhận mật khẩu
        document.getElementById('confirmPasswordBtn').addEventListener('click', async function() {
            const passwordInput = document.getElementById('twoFactorPassword');
            const password = passwordInput.value;
            
            if (!password) {
                showError('Vui lòng nhập mật khẩu');
                return;
            }
            
            showStatus('Đang xác thực...', 'info');
            
            // Implement mã xác thực mật khẩu hai lớp
            showError('Chức năng đăng nhập bằng mật khẩu hai lớp chưa được hỗ trợ');
        });
        
        // Hiển thị bước
        function showStep(stepElement) {
            // Ẩn tất cả các bước
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Hiển thị bước được chọn
            stepElement.classList.add('active');
        }
        
        // Hiển thị lỗi
        function showError(message) {
            statusContainer.style.display = 'block';
            statusContainer.className = 'status-container status-error';
            statusMessage.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i> ${message}`;
            errorHelp.textContent = message;
            errorCode.textContent = message;
            errorDetails.classList.remove('d-none');
            
            // Gửi thông báo lỗi cho cửa sổ chính
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({
                    type: 'telegram_login_error',
                    error: message,
                    details: {
                        phoneNumber: document.getElementById('phoneNumber').value,
                        errorText: message,
                        errorType: 'connection_error'
                    }
                }, '*');
            }
        }
        
        // Hiển thị thông báo trạng thái
        function showStatus(message, type = 'info') {
            statusContainer.style.display = 'block';
            statusContainer.className = `status-container status-${type}`;
            statusMessage.innerHTML = `<i class="bi bi-info-circle-fill me-2"></i> ${message}`;
        }
        
        // Ẩn thông báo
        function hideStatus() {
            statusContainer.style.display = 'none';
            errorDetails.classList.add('d-none');
        }
    </script>
</body>
</html> 